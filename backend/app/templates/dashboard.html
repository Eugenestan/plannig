<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Дашборд — {{ team.name }}</title>
  <link rel="stylesheet" href="/static/styles.css?v=2">
  <style>
    /* Черный текст в раскрывающемся списке селектов */
    #days option,
    #done-user-select option,
    #done-period-select option,
    #no-release-user-select option,
    #filter-type-select option,
    #filter-user-select option,
    #filter-period-select option {
      color: #000;
      background-color: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div>
        <a class="muted" href="/teams/{{ team.id }}">&larr; назад к выбору сотрудников</a>
        <h1>Дашборд: {{ team.name }}</h1>
        <p class="muted">Метрики и аналитика команды</p>
      </div>
    </header>

    <!-- Табы -->
    <div class="card" style="margin-bottom: 0; border-bottom: none; border-radius: 14px 14px 0 0; padding: 0; max-width: 980px; margin-left: auto; margin-right: auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div style="display: flex; gap: 0; border-bottom: 1px solid var(--border);">
        <button id="tab-time" class="tab-button active" onclick="switchTab('time')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid var(--primary); cursor: pointer; font-weight: 600;">
          Списано времени
        </button>
        <button id="tab-epics" class="tab-button" onclick="switchTab('epics')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted);">
          Эпики
        </button>
        <button id="tab-releases" class="tab-button" onclick="switchTab('releases')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted);">
          Релизы
        </button>
        <button id="tab-filters" class="tab-button" onclick="switchTab('filters')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted);">
          Фильтры
        </button>
        <button id="tab-improve" class="tab-button" onclick="switchTab('improve')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted);">
          Improve
        </button>
        <button id="tab-gantt" class="tab-button" onclick="switchTab('gantt')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted);">
          Гант
        </button>
      </div>
    </div>

    <!-- Таб: Списано времени -->
    <div id="tab-content-time" class="tab-content" style="max-width: 980px; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 16px; width: 100%; box-sizing: border-box;">
        <div class="toolbar">
          <h2>Списано времени</h2>
          <div style="display: flex; gap: 10px; align-items: center;">
            <label for="days" class="muted">Период:</label>
            <select id="days" class="input" style="width: auto; padding: 6px 10px;" onchange="window.location.href='?days=' + this.value">
              <option value="today" {% if days == 'today' %}selected{% endif %}>Сегодня</option>
              <option value="yesterday" {% if days == 'yesterday' %}selected{% endif %}>Вчера</option>
              <option value="8" {% if days == '8' %}selected{% endif %}>За последние 8 дней</option>
            </select>
          </div>
        </div>

      <div id="worklog-loading" style="text-align: center; padding: 20px;">
        <p class="muted">Загрузка данных...</p>
      </div>
      <div id="worklog-error" style="display: none;"></div>
      <div id="worklog-content" style="display: none;">
        <div style="overflow-x: auto; margin: 0 -16px; padding: 0 16px;">
          <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
            <thead>
              <tr style="border-bottom: 1px solid var(--border);">
                <th style="text-align: left; padding: 10px;">Сотрудник</th>
                <th style="text-align: right; padding: 10px;">Часов</th>
                <th style="text-align: right; padding: 10px;">Записей</th>
              </tr>
            </thead>
            <tbody id="worklog-tbody">
            </tbody>
            <tfoot id="worklog-tfoot">
            </tfoot>
          </table>
        </div>
      </div>
    </div>
    </div>

    <!-- Таб: Эпики -->
    <div id="tab-content-epics" class="tab-content" style="display: none; max-width: 980px; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 16px; width: 100%; box-sizing: border-box;">
        <div class="toolbar">
          <h2>Эпики</h2>
        </div>

        <div id="epics-loading" style="text-align: center; padding: 20px;">
          <p class="muted">Загрузка данных...</p>
        </div>
        <div id="epics-error" style="display: none;"></div>
        <div id="epics-content" style="display: none;">
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
              <thead>
                <tr style="border-bottom: 1px solid var(--border);">
                  <th style="text-align: left; padding: 10px;">Ключ</th>
                  <th style="text-align: left; padding: 10px;">Название</th>
                  <th style="text-align: left; padding: 10px;">Статус</th>
                  <th style="text-align: left; padding: 10px;">Обновлено</th>
                  <th style="text-align: left; padding: 10px;">Создано</th>
                </tr>
              </thead>
              <tbody id="epics-tbody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- Таб: Релизы -->
    <div id="tab-content-releases" class="tab-content" style="display: none; max-width: 980px; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 16px; width: 100%; box-sizing: border-box;">
        <div class="toolbar">
          <h2>Релизы</h2>
        </div>

        <div id="releases-loading" style="text-align: center; padding: 20px;">
          <p class="muted">Загрузка данных...</p>
        </div>
        <div id="releases-error" style="display: none;"></div>
        <div id="releases-content" style="display: none;">
          <div style="overflow-x: auto; max-width: 100%;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 12px; max-width: 100%; table-layout: fixed;">
              <colgroup>
                <col style="width: 60%;">
                <col style="width: 40%;">
              </colgroup>
              <thead>
                <tr style="border-bottom: 1px solid var(--border);">
                  <th style="text-align: left; padding: 10px;">Название эпика</th>
                  <th style="text-align: left; padding: 10px;">Дата релиза</th>
                </tr>
              </thead>
              <tbody id="releases-tbody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Таб: Фильтры -->
    <div id="tab-content-filters" class="tab-content" style="display: none; max-width: 980px; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 16px; width: 100%; box-sizing: border-box;">
        <div class="toolbar">
          <h2>Фильтры по задачам</h2>
        </div>
        
        <div style="display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--muted);">Фильтр:</label>
            <select id="filter-type-select" class="input" style="width: 100%;" onchange="onFilterTypeChange()">
              <option value="">Выберите фильтр</option>
              <option value="done">Закрытые задачи</option>
              <option value="no-release">Задачи без релиза</option>
            </select>
          </div>
          
          <!-- Селект сотрудника (появляется при выборе фильтра) -->
          <div id="filter-user-container" style="flex: 1; min-width: 200px; display: none;">
            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--muted);">Сотрудник:</label>
            <select id="filter-user-select" class="input" style="width: 100%;" onchange="loadFilterTasks()">
              <option value="">Выберите сотрудника</option>
            </select>
          </div>
          
          <!-- Селект периода (только для "Закрытые задачи") -->
          <div id="filter-period-container" style="flex: 1; min-width: 200px; display: none;">
            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--muted);">Период:</label>
            <select id="filter-period-select" class="input" style="width: 100%;" onchange="loadFilterTasks()">
              <option value="today">Сегодня</option>
              <option value="yesterday">Вчера</option>
              <option value="week">За неделю</option>
            </select>
          </div>
        </div>
        
        <div id="filter-loading" style="text-align: center; padding: 40px; color: var(--muted);">
          Выберите фильтр для загрузки задач
        </div>
        <div id="filter-error" style="display: none;"></div>
        <div id="filter-content" style="display: none;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid var(--border);">
                <th style="padding: 10px; text-align: left; font-weight: 600;">Задача</th>
                <th style="padding: 10px; text-align: left; font-weight: 600;">Название</th>
                <th id="filter-th-extra" style="padding: 10px; text-align: left; font-weight: 600; display: none;"></th>
                <th style="padding: 10px; text-align: left; font-weight: 600;">Дата</th>
              </tr>
            </thead>
            <tbody id="filter-tbody">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Таб: Improve -->
    <div id="tab-content-improve" class="tab-content" style="display: none; max-width: 980px; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 16px; width: 100%; box-sizing: border-box;">
        <div class="toolbar">
          <h2>Improve</h2>
        </div>
        
        <div id="improve-loading" style="text-align: center; padding: 40px; color: var(--muted);">
          Загрузка данных...
        </div>
        <div id="improve-error" style="display: none;"></div>
        <div id="improve-content" style="display: none;">
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
              <thead>
                <tr style="border-bottom: 2px solid var(--border);">
                  <th style="padding: 10px; text-align: left; font-weight: 600;">Ключ</th>
                  <th style="padding: 10px; text-align: left; font-weight: 600;">Заголовок</th>
                  <th style="padding: 10px; text-align: left; font-weight: 600;">Создано</th>
                </tr>
              </thead>
              <tbody id="improve-tbody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Таб: Гант -->
    <div id="tab-content-gantt" class="tab-content" style="display: none; max-width: 100%; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 16px; width: 100%; box-sizing: border-box;">
        <div class="toolbar" style="margin-bottom: 16px;">
          <h2>Диаграмма Ганта</h2>
          <div style="display: flex; gap: 10px;">
            <button id="gantt-auto-distribute" class="button" onclick="autoDistributeTasks()" style="display: none;">
              Распределить автоматически
            </button>
            <button id="gantt-remove-auto" class="button" onclick="removeAutoDistribution()" style="display: none;">
              Убрать автоматическое распределение
            </button>
            <button id="gantt-save" class="button primary" onclick="saveGanttState()" style="display: none;">
              Сохранить
            </button>
          </div>
        </div>
        
        <div id="gantt-loading" style="text-align: center; padding: 40px; color: var(--muted);">
          Загрузка данных...
        </div>
        <div id="gantt-error" style="display: none;"></div>
        <div id="gantt-content" style="display: none; overflow-x: auto;">
          <div id="gantt-container" style="position: relative; min-width: 100%;">
            <!-- Календарная сетка будет здесь -->
            <div id="gantt-calendar" style="position: sticky; top: 0; z-index: 10; background: var(--card); border-bottom: 2px solid var(--border);"></div>
            <!-- Эпики и задачи будут здесь -->
            <div id="gantt-tasks" style="position: relative;">
            </div>
            <!-- SVG для связей между задачами -->
            <svg id="gantt-connections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: visible;"></svg>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const days = {{ days|tojson }};
    const teamId = {{ team.id }};
    
    async function loadWorklog() {
      const loading = document.getElementById('worklog-loading');
      const errorDiv = document.getElementById('worklog-error');
      const content = document.getElementById('worklog-content');
      const tbody = document.getElementById('worklog-tbody');
      const tfoot = document.getElementById('worklog-tfoot');
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 минуты
        let response;
        try {
          response = await fetch(`/api/teams/${teamId}/worklog?days=${days}`, {
            signal: controller.signal
          });
          clearTimeout(timeoutId);
        } catch (fetchError) {
          clearTimeout(timeoutId);
          if (fetchError.name === 'AbortError') {
            throw new Error('Запрос превысил время ожидания');
          }
          throw fetchError;
        }
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        loading.style.display = 'none';
        
        if (!result.success) {
          errorDiv.innerHTML = `<div class="card error"><p><b>Ошибка:</b> ${result.error}</p></div>`;
          errorDiv.style.display = 'block';
          return;
        }
        
        const data = result.data || [];
        if (data.length === 0) {
          errorDiv.innerHTML = '<p class="muted">Нет данных о списанном времени за выбранный период.</p>';
          errorDiv.style.display = 'block';
          return;
        }
        
        // Заполняем таблицу
        let html = '';
        let totalHours = 0;
        let totalEntries = 0;
        
        data.forEach((item, idx) => {
          totalHours += item.total_hours;
          totalEntries += item.entries.length;
          html += `
            <tr style="border-bottom: 1px solid var(--border); cursor: pointer;" onclick="toggleDetails(${idx})">
              <td style="padding: 10px;">
                <div style="font-weight: 600;">${escapeHtml(item.user_name)}</div>
                <div class="muted" style="font-size: 12px;">${escapeHtml(item.user_account_id)}</div>
              </td>
              <td style="text-align: right; padding: 10px; font-weight: 600;">
                ${item.total_hours.toFixed(1)} ч
              </td>
              <td style="text-align: right; padding: 10px; color: var(--muted);">
                ${item.entries.length}
              </td>
            </tr>
            <tr id="details-${idx}" style="display: none; background: rgba(0,0,0,0.1);">
              <td colspan="3" style="padding: 10px 10px 10px 30px;">
                <div style="font-size: 13px;">
                  ${formatEntries(item.entries, days)}
                </div>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
        tfoot.innerHTML = `
          <tr style="border-top: 2px solid var(--border); font-weight: 600;">
            <td style="padding: 10px;">Всего</td>
            <td style="text-align: right; padding: 10px;">${totalHours.toFixed(1)} ч</td>
            <td style="text-align: right; padding: 10px;">${totalEntries}</td>
          </tr>
        `;
        
        content.style.display = 'block';
      } catch (e) {
        loading.style.display = 'none';
        let errorMsg = e.message || 'Неизвестная ошибка';
        if (e.name === 'AbortError') {
          errorMsg = 'Запрос превысил время ожидания (3 минуты). Возможно, Jira API медленно отвечает. Попробуйте еще раз или выберите другой период.';
        } else if (e.message && e.message.includes('HTTP')) {
          errorMsg = e.message;
        }
        errorDiv.innerHTML = `<div class="card error"><p><b>Ошибка загрузки:</b> ${escapeHtml(errorMsg)}</p><p style="font-size: 12px; color: var(--muted); margin-top: 8px;">Если проблема повторяется, проверьте подключение к Jira API или попробуйте выбрать другой период.</p></div>`;
        errorDiv.style.display = 'block';
        console.error('Worklog loading error:', e);
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    function formatDate(dateStr) {
      // Преобразуем "2025-12-29" в "29.12"
      if (!dateStr) return '';
      const parts = dateStr.split('-');
      if (parts.length === 3) {
        return `${parts[2]}.${parts[1]}`;
      }
      return dateStr;
    }
    
    function formatEntries(entries, period) {
      // Если период "8 дней", группируем по датам
      if (period === '8' || period === 8) {
        // Группируем записи по датам
        const groupedByDate = {};
        entries.forEach(entry => {
          const date = entry.worklog_date || (entry.started ? entry.started.substring(0, 10) : '');
          if (!date) return;
          
          if (!groupedByDate[date]) {
            groupedByDate[date] = {
              date: date,
              entries: [],
              totalSeconds: 0
            };
          }
          groupedByDate[date].entries.push(entry);
          groupedByDate[date].totalSeconds += entry.time_spent_seconds || 0;
        });
        
        // Сортируем даты по убыванию
        const sortedDates = Object.keys(groupedByDate).sort().reverse();
        
        return sortedDates.map(date => {
          const group = groupedByDate[date];
          const totalHours = group.totalSeconds / 3600;
          
          return `
            <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid rgba(255,255,255,0.2);">
              <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">
                ${formatDate(date)} - ${totalHours.toFixed(1)} часов
              </div>
              <div style="margin-left: 12px;">
                ${group.entries.map(entry => `
                  <div style="padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between;">
                      <div>
                        <strong>${escapeHtml(entry.issue_key)}</strong>: ${escapeHtml((entry.issue_summary || '').substring(0, 60))}${(entry.issue_summary || '').length > 60 ? '...' : ''}
                        ${entry.comment ? `<div class="muted" style="margin-top: 4px; font-size: 11px;">${escapeHtml(entry.comment.substring(0, 100))}${entry.comment.length > 100 ? '...' : ''}</div>` : ''}
                      </div>
                      <div style="text-align: right; margin-left: 12px;">
                        <div>${escapeHtml(entry.time_spent || '')}</div>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }).join('');
      } else {
        // Для других периодов показываем просто список
        return entries.map(entry => `
          <div style="padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; justify-content: space-between;">
              <div>
                <strong>${escapeHtml(entry.issue_key)}</strong>: ${escapeHtml((entry.issue_summary || '').substring(0, 60))}${(entry.issue_summary || '').length > 60 ? '...' : ''}
                ${entry.comment ? `<div class="muted" style="margin-top: 4px; font-size: 11px;">${escapeHtml(entry.comment.substring(0, 100))}${entry.comment.length > 100 ? '...' : ''}</div>` : ''}
              </div>
              <div style="text-align: right; margin-left: 12px;">
                <div>${escapeHtml(entry.time_spent || '')}</div>
                <div class="muted" style="font-size: 11px;">
                  ${entry.started ? escapeHtml(entry.started.substring(0, 10)) : ''}
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }
    }
    
    function toggleDetails(index) {
      const row = document.getElementById('details-' + index);
      if (row.style.display === 'none') {
        row.style.display = 'table-row';
      } else {
        row.style.display = 'none';
      }
    }
    
    // Функция переключения табов
    function switchTab(tabName) {
      // Скрываем все табы
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.style.borderBottom = '2px solid transparent';
        btn.style.color = 'var(--muted)';
      });
      
      // Показываем выбранный таб
      const content = document.getElementById('tab-content-' + tabName);
      const button = document.getElementById('tab-' + tabName);
      if (content) {
        content.style.display = 'block';
      }
      if (button) {
        button.classList.add('active');
        button.style.borderBottom = '2px solid var(--primary)';
        button.style.color = 'inherit';
      }
      
      // Загружаем данные для таба "Эпики" при первом открытии
      if (tabName === 'epics' && !window.epicsLoaded) {
        loadEpics();
        window.epicsLoaded = true;
      }
      
      // Загружаем данные для таба "Релизы" при первом открытии
      if (tabName === 'releases' && !window.releasesLoaded) {
        loadReleases();
        window.releasesLoaded = true;
      }
      
      // Загружаем данные для таба "Фильтры" при первом открытии
      if (tabName === 'filters') {
        loadFilterUsers();
      }
      
      // Загружаем данные для таба "Improve" при первом открытии
      if (tabName === 'improve' && !window.improveLoaded) {
        loadImprove();
        window.improveLoaded = true;
      }
      
      // Загружаем данные для таба "Гант" при первом открытии
      if (tabName === 'gantt' && !window.ganttLoaded) {
        loadGantt();
        window.ganttLoaded = true;
      }
    }
    
    // Функция загрузки эпиков
    async function loadEpics() {
      const loading = document.getElementById('epics-loading');
      const errorDiv = document.getElementById('epics-error');
      const content = document.getElementById('epics-content');
      const tbody = document.getElementById('epics-tbody');
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 минуты
        const response = await fetch(`/api/teams/${teamId}/epics`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        const result = await response.json();
        
        loading.style.display = 'none';
        
        if (!result.success) {
          errorDiv.innerHTML = `<div class="card error"><p><b>Ошибка:</b> ${result.error}</p></div>`;
          errorDiv.style.display = 'block';
          return;
        }
        
        const epics = result.data || [];
        if (epics.length === 0) {
          errorDiv.innerHTML = '<p class="muted">Нет эпиков для отображения.</p>';
          errorDiv.style.display = 'block';
          return;
        }
        
        // Форматируем даты
        function formatDate(dateStr) {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        // Заполняем таблицу
        let html = '';
        epics.forEach((epic, idx) => {
          html += `
            <tr style="border-bottom: 1px solid var(--border); cursor: pointer;" onclick="toggleEpicIssues(${idx}, '${escapeHtml(epic.key)}')">
              <td style="padding: 10px;">
                <a href="https://topntop.atlassian.net/browse/${escapeHtml(epic.key)}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;" onclick="event.stopPropagation();">
                  ${escapeHtml(epic.key)}
                </a>
              </td>
              <td style="padding: 10px;">${escapeHtml(epic.summary || '')}</td>
              <td style="padding: 10px;">${escapeHtml(epic.status || '')}</td>
              <td style="padding: 10px; color: var(--muted); font-size: 13px;">${formatDate(epic.updated)}</td>
              <td style="padding: 10px; color: var(--muted); font-size: 13px;">${formatDate(epic.created)}</td>
            </tr>
            <tr id="epic-issues-${idx}" style="display: none; background: rgba(0,0,0,0.1);">
              <td colspan="5" style="padding: 10px 10px 10px 30px;">
                <div id="epic-issues-loading-${idx}" style="text-align: center; padding: 10px;">
                  <p class="muted" style="font-size: 13px;">Загрузка задач...</p>
                </div>
                <div id="epic-issues-content-${idx}" style="display: none;">
                  <div style="font-size: 13px;">
                    <table style="width: 100%; border-collapse: collapse;">
                      <thead>
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                          <th style="text-align: left; padding: 8px; font-size: 12px; color: var(--muted);">Задача</th>
                          <th style="text-align: left; padding: 8px; font-size: 12px; color: var(--muted);">Ответственный</th>
                          <th style="text-align: right; padding: 8px; font-size: 12px; color: var(--muted);">Исходная оценка</th>
                          <th style="text-align: right; padding: 8px; font-size: 12px; color: var(--muted);">Списано времени</th>
                        </tr>
                      </thead>
                      <tbody id="epic-issues-tbody-${idx}">
                      </tbody>
                    </table>
                  </div>
                </div>
                <div id="epic-issues-error-${idx}" style="display: none;"></div>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
        content.style.display = 'block';
      } catch (e) {
        loading.style.display = 'none';
        let errorMsg = e.message;
        if (e.name === 'AbortError') {
          errorMsg = 'Запрос превысил время ожидания. Попробуйте еще раз.';
        }
        errorDiv.innerHTML = `<div class="card error"><p><b>Ошибка загрузки:</b> ${escapeHtml(errorMsg)}</p></div>`;
        errorDiv.style.display = 'block';
      }
    }
    
    // Функция переключения задач эпика
    async function toggleEpicIssues(index, epicKey) {
      const row = document.getElementById('epic-issues-' + index);
      const loading = document.getElementById('epic-issues-loading-' + index);
      const content = document.getElementById('epic-issues-content-' + index);
      const errorDiv = document.getElementById('epic-issues-error-' + index);
      const tbody = document.getElementById('epic-issues-tbody-' + index);
      
      if (row.style.display === 'none') {
        // Разворачиваем
        row.style.display = 'table-row';
        
        // Если данные еще не загружены, загружаем их
        if (!row.dataset.loaded) {
          loading.style.display = 'block';
          content.style.display = 'none';
          errorDiv.style.display = 'none';
          
          try {
            const response = await fetch(`/api/epics/${epicKey}/issues`);
            const result = await response.json();
            
            loading.style.display = 'none';
            
            if (!result.success) {
              errorDiv.innerHTML = `<p class="muted" style="font-size: 13px; color: #ff5b5b;">Ошибка: ${escapeHtml(result.error)}</p>`;
              errorDiv.style.display = 'block';
              return;
            }
            
            const issues = result.data || [];
            if (issues.length === 0) {
              errorDiv.innerHTML = '<p class="muted" style="font-size: 13px;">Нет задач в этом эпике.</p>';
              errorDiv.style.display = 'block';
              return;
            }
            
            // Заполняем таблицу задач
            let html = '';
            issues.forEach(issue => {
              html += `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                  <td style="padding: 8px;">
                    <a href="https://topntop.atlassian.net/browse/${escapeHtml(issue.key)}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                      ${escapeHtml(issue.key)}
                    </a>
                    <div style="font-size: 12px; color: var(--muted); margin-top: 2px;">
                      ${escapeHtml(issue.summary || '')}
                    </div>
                  </td>
                  <td style="padding: 8px;">${escapeHtml(issue.assignee || 'Не назначен')}</td>
                  <td style="text-align: right; padding: 8px;">${issue.original_estimate_hours > 0 ? issue.original_estimate_hours.toFixed(1) + ' ч' : '-'}</td>
                  <td style="text-align: right; padding: 8px;">${issue.time_spent_hours > 0 ? issue.time_spent_hours.toFixed(1) + ' ч' : '-'}</td>
                </tr>
              `;
            });
            
            tbody.innerHTML = html;
            content.style.display = 'block';
            row.dataset.loaded = 'true';
          } catch (e) {
            loading.style.display = 'none';
            errorDiv.innerHTML = `<p class="muted" style="font-size: 13px; color: #ff5b5b;">Ошибка загрузки: ${escapeHtml(e.message)}</p>`;
            errorDiv.style.display = 'block';
          }
        }
      } else {
        // Сворачиваем
        row.style.display = 'none';
      }
    }
    
    // Функция загрузки релизов
    async function loadReleases() {
      const loading = document.getElementById('releases-loading');
      const errorDiv = document.getElementById('releases-error');
      const content = document.getElementById('releases-content');
      const tbody = document.getElementById('releases-tbody');
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 минуты
        const response = await fetch(`/api/teams/${teamId}/releases`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        const result = await response.json();
        
        loading.style.display = 'none';
        
        if (!result.success) {
          errorDiv.innerHTML = `<div class="card error"><p><b>Ошибка:</b> ${result.error}</p></div>`;
          errorDiv.style.display = 'block';
          return;
        }
        
        const releases = result.data || [];
        if (releases.length === 0) {
          errorDiv.innerHTML = '<p class="muted">Нет релизов для отображения.</p>';
          errorDiv.style.display = 'block';
          return;
        }
        
        // Форматируем даты
        function formatDate(dateStr) {
          if (!dateStr) return '';
          const date = new Date(dateStr + 'T00:00:00');
          return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        // Проверяем, просрочен ли релиз
        function isOverdue(releaseDateStr) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const releaseDate = new Date(releaseDateStr + 'T00:00:00');
          return releaseDate < today;
        }
        
        // Заполняем таблицу
        let html = '';
        releases.forEach((release, idx) => {
          const isOverdueRelease = isOverdue(release.release_date);
          const borderStyle = isOverdueRelease ? 'border-left: 3px solid #ff5b5b;' : '';
          
          html += `
            <tr style="border-bottom: 1px solid var(--border); ${borderStyle}">
              <td style="padding: 10px; word-wrap: break-word; max-width: 0;">
                <a href="https://topntop.atlassian.net/browse/${escapeHtml(release.epic_key)}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                  ${escapeHtml(release.epic_key)}
                </a>
                <div style="font-size: 13px; color: var(--muted); margin-top: 4px; word-wrap: break-word;">
                  ${escapeHtml(release.epic_summary || '')}
                </div>
              </td>
              <td style="padding: 10px;">
                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                  <div style="position: relative; display: inline-block;">
                    <input 
                      type="date" 
                      id="release-date-${idx}" 
                      value="${release.release_date}" 
                      class="date-picker-input"
                      data-original-date="${release.release_date}"
                      onclick="showSaveButton(${idx})"
                    />
                  </div>
                  <button 
                    id="save-btn-${idx}" 
                    class="save-date-button"
                    style="display: none;"
                    onclick="saveReleaseDate('${escapeHtml(release.epic_key)}', ${idx})"
                  >
                    Сохранить
                  </button>
                  <button 
                    id="cancel-btn-${idx}" 
                    class="cancel-date-button"
                    style="display: none;"
                    onclick="cancelDateChange(${idx})"
                  >
                    Отмена
                  </button>
                  <span id="release-date-status-${idx}" class="release-date-status"></span>
                </div>
                ${release.version_name ? `<div style="font-size: 12px; color: var(--muted); margin-top: 4px;">${escapeHtml(release.version_name)}</div>` : ''}
                ${isOverdueRelease ? '<div style="font-size: 12px; color: #ff5b5b; margin-top: 2px;">Просрочено</div>' : ''}
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
        content.style.display = 'block';
      } catch (e) {
        loading.style.display = 'none';
        let errorMsg = e.message;
        if (e.name === 'AbortError') {
          errorMsg = 'Запрос превысил время ожидания. Попробуйте еще раз.';
        }
        errorDiv.innerHTML = `<div class="card error"><p><b>Ошибка загрузки:</b> ${escapeHtml(errorMsg)}</p></div>`;
        errorDiv.style.display = 'block';
      }
    }
    
    // Функция обновления даты релиза
    async function updateReleaseDate(epicKey, newDate, index) {
      const statusEl = document.getElementById('release-date-status-' + index);
      statusEl.textContent = 'Сохранение...';
      statusEl.style.color = 'var(--muted)';
      
      try {
        const response = await fetch(`/api/epics/${epicKey}/release-date`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ release_date: newDate })
        });
        
        const result = await response.json();
        
        if (result.success) {
          statusEl.textContent = '✓ Сохранено';
          statusEl.style.color = '#5bff8c';
          setTimeout(() => {
            statusEl.textContent = '';
          }, 2000);
          
          // Перезагружаем список релизов, чтобы обновить статус просроченных
          loadReleases();
        } else {
          statusEl.textContent = '✗ Ошибка';
          statusEl.style.color = '#ff5b5b';
          alert('Ошибка обновления даты: ' + result.error);
        }
      } catch (e) {
        statusEl.textContent = '✗ Ошибка';
        statusEl.style.color = '#ff5b5b';
        alert('Ошибка обновления даты: ' + e.message);
      }
    }
    
    // Функция показа кнопок "Сохранить" и "Отмена"
    function showSaveButton(index) {
      const saveBtn = document.getElementById('save-btn-' + index);
      const cancelBtn = document.getElementById('cancel-btn-' + index);
      const dateInput = document.getElementById('release-date-' + index);
      const originalDate = dateInput.getAttribute('data-original-date');
      const currentDate = dateInput.value;
      
      // Показываем кнопки только если дата изменилась
      if (currentDate !== originalDate) {
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
      } else {
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
      }
    }
    
    // Функция отмены изменения даты
    function cancelDateChange(index) {
      const dateInput = document.getElementById('release-date-' + index);
      const saveBtn = document.getElementById('save-btn-' + index);
      const cancelBtn = document.getElementById('cancel-btn-' + index);
      const statusEl = document.getElementById('release-date-status-' + index);
      const originalDate = dateInput.getAttribute('data-original-date');
      
      // Возвращаем исходную дату
      dateInput.value = originalDate;
      
      // Скрываем кнопки
      saveBtn.style.display = 'none';
      cancelBtn.style.display = 'none';
      
      // Очищаем статус
      statusEl.textContent = '';
      statusEl.style.background = '';
    }
    
    // Функция сохранения даты релиза
    async function saveReleaseDate(epicKey, index) {
      const dateInput = document.getElementById('release-date-' + index);
      const saveBtn = document.getElementById('save-btn-' + index);
      const statusEl = document.getElementById('release-date-status-' + index);
      const newDate = dateInput.value;
      
      if (!newDate) {
        alert('Выберите дату');
        return;
      }
      
      // Блокируем кнопку и показываем статус
      saveBtn.disabled = true;
      saveBtn.textContent = 'Сохранение...';
      statusEl.textContent = '';
      
      try {
        const response = await fetch(`/api/epics/${epicKey}/release-date`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ release_date: newDate })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // Обновляем оригинальную дату
          dateInput.setAttribute('data-original-date', newDate);
          
          // Скрываем кнопки
          const cancelBtn = document.getElementById('cancel-btn-' + index);
          saveBtn.style.display = 'none';
          cancelBtn.style.display = 'none';
          saveBtn.disabled = false;
          saveBtn.textContent = 'Сохранить';
          
          // Показываем статус успеха
          statusEl.textContent = '✓ Сохранено';
          statusEl.style.color = '#5bff8c';
          statusEl.style.background = 'rgba(91, 255, 140, 0.15)';
          setTimeout(() => {
            statusEl.textContent = '';
            statusEl.style.background = '';
          }, 2000);
          
          // Перезагружаем список релизов, чтобы обновить статус просроченных
          setTimeout(() => {
            loadReleases();
          }, 500);
        } else {
          saveBtn.disabled = false;
          saveBtn.textContent = 'Сохранить';
          statusEl.textContent = '✗ Ошибка';
          statusEl.style.color = '#ff5b5b';
          statusEl.style.background = 'rgba(255, 91, 91, 0.15)';
          alert('Ошибка обновления даты: ' + result.error);
        }
      } catch (e) {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Сохранить';
        statusEl.textContent = '✗ Ошибка';
        statusEl.style.color = '#ff5b5b';
        statusEl.style.background = 'rgba(255, 91, 91, 0.15)';
        alert('Ошибка обновления даты: ' + e.message);
      }
    }
    
    // Обработчик изменения даты для показа кнопки
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('date-picker-input')) {
        const index = e.target.id.replace('release-date-', '');
        showSaveButton(index);
      }
    });
    
    // Функция загрузки списка сотрудников для таба Фильтры
    async function loadFilterUsers() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 секунд
        const response = await fetch(`/api/teams/${teamId}/users`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const select = document.getElementById('filter-user-select');
          if (select) {
            select.innerHTML = '<option value="">Выберите сотрудника</option>';
            
            result.data.forEach(user => {
              const option = document.createElement('option');
              option.value = user.jira_account_id || '';
              option.textContent = user.display_name || user.name || 'Без имени';
              select.appendChild(option);
            });
          }
        } else {
          console.error('Ошибка загрузки сотрудников:', result.error || 'Неизвестная ошибка');
        }
      } catch (e) {
        console.error('Ошибка загрузки сотрудников:', e);
        if (e.name === 'AbortError') {
          console.error('Запрос превысил время ожидания');
        }
      }
    }
    
    // Обработчик изменения типа фильтра
    function onFilterTypeChange() {
      const filterType = document.getElementById('filter-type-select').value;
      const userContainer = document.getElementById('filter-user-container');
      const periodContainer = document.getElementById('filter-period-container');
      const loading = document.getElementById('filter-loading');
      const content = document.getElementById('filter-content');
      const errorDiv = document.getElementById('filter-error');
      
      // Скрываем все дополнительные селекты и контент
      userContainer.style.display = 'none';
      periodContainer.style.display = 'none';
      content.style.display = 'none';
      errorDiv.style.display = 'none';
      
      if (!filterType) {
        loading.style.display = 'block';
        loading.textContent = 'Выберите фильтр для загрузки задач';
        return;
      }
      
      // Показываем селект сотрудника для обоих типов фильтров
      userContainer.style.display = 'block';
      
      // Показываем селект периода только для "Закрытые задачи"
      if (filterType === 'done') {
        periodContainer.style.display = 'block';
      }
      
      // Загружаем список сотрудников, если еще не загружен
      const userSelect = document.getElementById('filter-user-select');
      if (userSelect.options.length <= 1) {
        loadFilterUsers();
      }
      
      loading.style.display = 'block';
      loading.textContent = 'Выберите сотрудника' + (filterType === 'done' ? ' и период' : '') + ' для загрузки задач';
    }
    
    // Функция загрузки задач по фильтру
    async function loadFilterTasks() {
      const filterType = document.getElementById('filter-type-select').value;
      const userSelect = document.getElementById('filter-user-select');
      const periodSelect = document.getElementById('filter-period-select');
      const loading = document.getElementById('filter-loading');
      const errorDiv = document.getElementById('filter-error');
      const content = document.getElementById('filter-content');
      const tbody = document.getElementById('filter-tbody');
      const extraTh = document.getElementById('filter-th-extra');
      
      if (!filterType) {
        loading.style.display = 'block';
        loading.textContent = 'Выберите фильтр для загрузки задач';
        errorDiv.style.display = 'none';
        content.style.display = 'none';
        return;
      }
      
      const userId = userSelect ? userSelect.value : '';
      
      // Для "Закрытые задачи" требуется и сотрудник, и период
      if (filterType === 'done') {
        if (!userId) {
          loading.style.display = 'block';
          loading.textContent = 'Выберите сотрудника и период для загрузки задач';
          errorDiv.style.display = 'none';
          content.style.display = 'none';
          return;
        }
      } else if (filterType === 'no-release') {
        // Для "Задачи без релиза" сотрудник опционален
      }
      
      loading.style.display = 'block';
      loading.textContent = 'Загрузка задач...';
      errorDiv.style.display = 'none';
      content.style.display = 'none';
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 минуты
        
        let url;
        if (filterType === 'done') {
          const period = periodSelect ? periodSelect.value : 'today';
          url = `/api/teams/${teamId}/done?user_id=${encodeURIComponent(userId)}&period=${period}`;
        } else {
          url = userId 
            ? `/api/teams/${teamId}/no-release?user_id=${encodeURIComponent(userId)}`
            : `/api/teams/${teamId}/no-release`;
        }
        
        const response = await fetch(url, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        const result = await response.json();
        
        loading.style.display = 'none';
        
        if (!result.success) {
          errorDiv.innerHTML = `<div class="card error"><p><b>Ошибка:</b> ${result.error}</p></div>`;
          errorDiv.style.display = 'block';
          return;
        }
        
        const tasks = result.data || [];
        if (tasks.length === 0) {
          const emptyMsg = filterType === 'done' 
            ? 'Нет выполненных задач за выбранный период.'
            : 'Нет задач без релиза.';
          errorDiv.innerHTML = `<p class="muted">${emptyMsg}</p>`;
          errorDiv.style.display = 'block';
          return;
        }
        
        // Функция форматирования даты
        function formatDate(dateStr) {
          if (!dateStr) return '-';
          const date = new Date(dateStr);
          return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        // Настраиваем заголовки таблицы в зависимости от типа фильтра
        const dateTh = document.querySelector('#filter-content thead tr th:last-child');
        if (filterType === 'done') {
          extraTh.textContent = '';
          extraTh.style.display = 'none';
          if (dateTh) dateTh.textContent = 'Дата завершения';
        } else {
          extraTh.textContent = 'Исполнитель';
          extraTh.style.display = '';
          if (dateTh) dateTh.textContent = 'Создано';
        }
        
        // Заполняем таблицу
        let html = '';
        tasks.forEach(task => {
          if (filterType === 'done') {
            html += `
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 10px;">
                  <a href="https://topntop.atlassian.net/browse/${escapeHtml(task.key)}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                    ${escapeHtml(task.key)}
                  </a>
                </td>
                <td style="padding: 10px;">
                  ${escapeHtml(task.summary || '')}
                </td>
                <td style="padding: 10px;">
                  ${task.resolved_date ? formatDate(task.resolved_date) : '-'}
                </td>
              </tr>
            `;
          } else {
            html += `
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 10px;">
                  <a href="https://topntop.atlassian.net/browse/${escapeHtml(task.key)}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                    ${escapeHtml(task.key)}
                  </a>
                </td>
                <td style="padding: 10px;">
                  ${escapeHtml(task.summary || '')}
                </td>
                <td style="padding: 10px;">
                  ${escapeHtml(task.assignee || '-')}
                </td>
                <td style="padding: 10px;">
                  ${formatDate(task.created)}
                </td>
              </tr>
            `;
          }
        });
        
        tbody.innerHTML = html;
        content.style.display = 'block';
      } catch (e) {
        loading.style.display = 'none';
        let errorMsg = e.message;
        if (e.name === 'AbortError') {
          errorMsg = 'Запрос превысил время ожидания. Попробуйте еще раз.';
        }
        errorDiv.innerHTML = `<div class="card error"><p><b>Ошибка загрузки:</b> ${escapeHtml(errorMsg)}</p></div>`;
        errorDiv.style.display = 'block';
      }
    }
    
    // Функция загрузки задач Improve
    async function loadImprove() {
      const loading = document.getElementById('improve-loading');
      const errorDiv = document.getElementById('improve-error');
      const content = document.getElementById('improve-content');
      const tbody = document.getElementById('improve-tbody');
      
      loading.style.display = 'block';
      errorDiv.style.display = 'none';
      content.style.display = 'none';
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 минуты
        const response = await fetch(`/api/teams/${teamId}/improve`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        const result = await response.json();
        
        loading.style.display = 'none';
        
        if (!result.success) {
          errorDiv.innerHTML = `<div class="card error"><p><b>Ошибка:</b> ${result.error}</p></div>`;
          errorDiv.style.display = 'block';
          return;
        }
        
        const tasks = result.data || [];
        if (tasks.length === 0) {
          errorDiv.innerHTML = '<p class="muted">Нет задач для отображения.</p>';
          errorDiv.style.display = 'block';
          return;
        }
        
        // Функция форматирования даты
        function formatDate(dateStr) {
          if (!dateStr) return '-';
          const date = new Date(dateStr);
          return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        // Заполняем таблицу
        let html = '';
        tasks.forEach((task, index) => {
          html += `
            <tr data-task-key="${escapeHtml(task.key)}" draggable="true" style="border-bottom: 1px solid var(--border); cursor: move;" 
                ondragstart="handleImproveDragStart(event)" 
                ondragover="handleImproveDragOver(event)" 
                ondragenter="handleImproveDragEnter(event)" 
                ondragleave="handleImproveDragLeave(event)" 
                ondrop="handleImproveDrop(event)" 
                ondragend="handleImproveDragEnd(event)">
              <td style="padding: 10px;">
                <a href="https://topntop.atlassian.net/browse/${escapeHtml(task.key)}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;" onclick="event.stopPropagation();">
                  ${escapeHtml(task.key)}
                </a>
              </td>
              <td style="padding: 10px;">
                ${escapeHtml(task.summary || '')}
              </td>
              <td style="padding: 10px; color: var(--muted); font-size: 13px;">
                ${formatDate(task.created)}
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
        content.style.display = 'block';
      } catch (e) {
        loading.style.display = 'none';
        let errorMsg = e.message;
        if (e.name === 'AbortError') {
          errorMsg = 'Запрос превысил время ожидания. Попробуйте еще раз.';
        }
        errorDiv.innerHTML = `<div class="card error"><p><b>Ошибка загрузки:</b> ${escapeHtml(errorMsg)}</p></div>`;
        errorDiv.style.display = 'block';
      }
    }
    
    // Переменные для drag-and-drop в таблице Improve
    let draggedImproveRow = null;
    let improveDragOverRow = null;
    
    // Обработчики drag-and-drop для таблицы Improve
    function handleImproveDragStart(e) {
      draggedImproveRow = e.target.closest('tr');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', draggedImproveRow.outerHTML);
      draggedImproveRow.style.opacity = '0.5';
    }
    
    function handleImproveDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      return false;
    }
    
    function handleImproveDragEnter(e) {
      const row = e.target.closest('tr');
      if (row && row !== draggedImproveRow && row.hasAttribute('data-task-key')) {
        improveDragOverRow = row;
        row.style.backgroundColor = 'rgba(0, 123, 255, 0.2)';
      }
    }
    
    function handleImproveDragLeave(e) {
      const row = e.target.closest('tr');
      if (row && row === improveDragOverRow) {
        row.style.backgroundColor = '';
        improveDragOverRow = null;
      }
    }
    
    function handleImproveDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      
      const dropRow = e.target.closest('tr');
      if (!dropRow || !draggedImproveRow || dropRow === draggedImproveRow || !dropRow.hasAttribute('data-task-key')) {
        return false;
      }
      
      const tbody = dropRow.parentNode;
      const allRows = Array.from(tbody.querySelectorAll('tr[data-task-key]'));
      const draggedIndex = allRows.indexOf(draggedImproveRow);
      const dropIndex = allRows.indexOf(dropRow);
      
      if (draggedIndex < dropIndex) {
        tbody.insertBefore(draggedImproveRow, dropRow.nextSibling);
      } else {
        tbody.insertBefore(draggedImproveRow, dropRow);
      }
      
      // Сохраняем новый порядок
      saveImproveOrder();
      
      return false;
    }
    
    function handleImproveDragEnd(e) {
      // Очищаем все стили перетаскивания
      const tbody = document.getElementById('improve-tbody');
      if (tbody) {
        const allRows = tbody.querySelectorAll('tr[data-task-key]');
        allRows.forEach(row => {
          row.style.opacity = '';
          row.style.backgroundColor = '';
        });
      }
      
      if (draggedImproveRow) {
        draggedImproveRow.style.opacity = '';
      }
      if (improveDragOverRow) {
        improveDragOverRow.style.backgroundColor = '';
        improveDragOverRow = null;
      }
      draggedImproveRow = null;
    }
    
    // Функция сохранения порядка задач Improve
    async function saveImproveOrder() {
      const tbody = document.getElementById('improve-tbody');
      if (!tbody) return;
      
      const rows = Array.from(tbody.querySelectorAll('tr[data-task-key]'));
      const taskKeys = rows.map(row => row.getAttribute('data-task-key'));
      
      if (taskKeys.length === 0) return;
      
      try {
        const response = await fetch(`/api/teams/${teamId}/improve/order`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ task_keys: taskKeys })
        });
        
        const result = await response.json();
        if (!result.success) {
          console.error('Ошибка сохранения порядка:', result.error);
        }
      } catch (e) {
        console.error('Ошибка при сохранении порядка:', e);
      }
    }
    
    // Загружаем данные при загрузке страницы
    loadWorklog();
    
    // ========== ДИАГРАММА ГАНТА ==========
    
    let ganttData = null;
    let ganttState = null;
    let ganttConnections = [];
    let ganttDraggedTask = null;
    let ganttConnectionMode = null;
    let ganttDayWidth = 20;
    let ganttRowHeight = 40;
    let ganttStartDate = null;
    let ganttEndDate = null;
    let ganttCalendarDays = [];
    let ganttAutoMode = false;
    let ganttExpandedEpics = {}; // Хранит состояние развернутости эпиков
    
    // Инициализация дат (5 месяцев с января текущего года)
    function initGanttDates() {
      const now = new Date();
      ganttStartDate = new Date(now.getFullYear(), 0, 1); // 1 января
      ganttEndDate = new Date(now.getFullYear(), 4, 31); // 31 мая (5 месяцев)
      
      // Генерируем массив дней
      ganttCalendarDays = [];
      const current = new Date(ganttStartDate);
      while (current <= ganttEndDate) {
        const dayOfWeek = current.getDay();
        ganttCalendarDays.push({
          date: new Date(current),
          isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
        });
        current.setDate(current.getDate() + 1);
      }
    }
    
    // Обработчик изменения размера окна и скролла для перерисовки связей
    let ganttResizeTimeout = null;
    window.addEventListener('resize', () => {
      if (ganttResizeTimeout) {
        clearTimeout(ganttResizeTimeout);
      }
      ganttResizeTimeout = setTimeout(() => {
        if (window.ganttLoaded) {
          renderGanttConnections();
        }
      }, 250);
    });
    
    const ganttContent = document.getElementById('gantt-content');
    if (ganttContent) {
      let ganttScrollTimeout = null;
      ganttContent.addEventListener('scroll', () => {
        if (ganttScrollTimeout) {
          clearTimeout(ganttScrollTimeout);
        }
        ganttScrollTimeout = setTimeout(() => {
          if (window.ganttLoaded) {
            renderGanttConnections();
          }
        }, 100);
      });
    }
    
    // Загрузка данных для Ганта
    async function loadGantt() {
      const loading = document.getElementById('gantt-loading');
      const error = document.getElementById('gantt-error');
      const content = document.getElementById('gantt-content');
      
      loading.style.display = 'block';
      error.style.display = 'none';
      content.style.display = 'none';
      
      try {
        const response = await fetch(`/api/teams/${teamId}/gantt`);
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || 'Ошибка загрузки данных');
        }
        
        ganttData = result.data;
        
        // Загружаем сохраненное состояние
        loadGanttState();
        
        // Инициализируем даты
        initGanttDates();
        
        // Рендерим диаграмму
        renderGantt();
        
        loading.style.display = 'none';
        content.style.display = 'block';
        
        // Показываем кнопки управления
        document.getElementById('gantt-auto-distribute').style.display = 'inline-block';
        if (ganttAutoMode) {
          document.getElementById('gantt-remove-auto').style.display = 'inline-block';
        }
      } catch (e) {
        console.error('Gantt load error:', e);
        loading.style.display = 'none';
        error.style.display = 'block';
        error.innerHTML = `Ошибка загрузки: ${e.message}`;
      }
    }
    
    // Рендеринг календарной сетки
    function renderGanttCalendar() {
      const calendarEl = document.getElementById('gantt-calendar');
      if (!calendarEl) return;
      
      const months = [];
      let currentMonth = null;
      
      ganttCalendarDays.forEach((day, index) => {
        const month = day.date.getMonth();
        const monthName = day.date.toLocaleString('ru-RU', { month: 'long' });
        
        if (!currentMonth || currentMonth.month !== month) {
          if (currentMonth) {
            months.push(currentMonth);
          }
          currentMonth = {
            month,
            name: monthName,
            days: [],
            startIndex: index,
          };
        }
        
        currentMonth.days.push(day);
      });
      
      if (currentMonth) {
        months.push(currentMonth);
      }
      
      // Вычисляем общую ширину календаря
      let totalCalendarWidth = 420; // Ширина столбца "Задача"
      months.forEach(month => {
        totalCalendarWidth += month.days.length * ganttDayWidth;
      });
      
      let html = '<div style="display: flex; border-bottom: 1px solid var(--border); min-width: ' + totalCalendarWidth + 'px;">';
      html += '<div style="width: 420px; min-width: 420px; flex-shrink: 0; padding: 8px; font-weight: 600; border-right: 1px solid var(--border);">Задача</div>';
      
      months.forEach(month => {
        const monthWidth = month.days.length * ganttDayWidth;
        html += `<div style="width: ${monthWidth}px; border-right: 1px solid var(--border);">`;
        html += `<div style="padding: 8px; font-weight: 600; text-align: center; border-bottom: 1px solid var(--border);">${month.name}</div>`;
        html += '<div style="display: flex;">';
        
        month.days.forEach(day => {
          const bgColor = day.isWeekend ? 'var(--border)' : 'transparent';
          const dayNum = day.date.getDate();
          html += `<div style="width: ${ganttDayWidth}px; padding: 4px; text-align: center; font-size: 11px; background: ${bgColor}; border-right: 1px solid var(--border);">${dayNum}</div>`;
        });
        
        html += '</div></div>';
      });
      
      html += '</div>';
      calendarEl.innerHTML = html;
      
      // Устанавливаем минимальную ширину для контейнера задач
      const tasksEl = document.getElementById('gantt-tasks');
      if (tasksEl) {
        tasksEl.style.minWidth = totalCalendarWidth + 'px';
      }
      
      // Сохраняем ширину для использования в других функциях
      window.ganttTotalWidth = totalCalendarWidth;
    }
    
    // Вычисление рабочих дней между датами
    function getWorkingDays(startDate, endDate) {
      let count = 0;
      const current = new Date(startDate);
      while (current <= endDate) {
        const dayOfWeek = current.getDay();
        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
          count++;
        }
        current.setDate(current.getDate() + 1);
      }
      return count;
    }
    
    // Получение даты начала для задачи (в рабочих днях от начала периода)
    function getTaskStartDate(task) {
      if (ganttState && ganttState.tasks && ganttState.tasks[task.id]) {
        return ganttState.tasks[task.id].startDate;
      }
      return null;
    }
    
    // Получение даты окончания для задачи
    function getTaskEndDate(task) {
      const startDate = getTaskStartDate(task);
      if (startDate === null) return null;
      
      const workingDays = Math.ceil(task.originalEstimate / 8);
      let current = new Date(ganttCalendarDays[startDate].date);
      let daysAdded = 0;
      
      while (daysAdded < workingDays) {
        const dayOfWeek = current.getDay();
        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
          daysAdded++;
        }
        if (daysAdded < workingDays) {
          current.setDate(current.getDate() + 1);
        }
      }
      
      // Находим индекс этой даты в календаре
      for (let i = 0; i < ganttCalendarDays.length; i++) {
        if (ganttCalendarDays[i].date.toDateString() === current.toDateString()) {
          return i;
        }
      }
      
      return startDate;
    }
    
    // Рендеринг эпиков и задач
    function renderGanttTasks() {
      const tasksEl = document.getElementById('gantt-tasks');
      if (!tasksEl || !ganttData) return;
      
      // Получаем общую ширину календаря
      const totalWidth = window.ganttTotalWidth || (420 + ganttCalendarDays.length * ganttDayWidth);
      
      let html = '';
      let rowIndex = 0;
      
      ganttData.forEach(epic => {
        // Строка эпика
        const epicStart = getEpicStartDate(epic);
        const epicEnd = getEpicEndDate(epic);
        const isExpanded = ganttExpandedEpics[epic.id] || false;
        const expandIcon = isExpanded ? '▼' : '▶';
        
        html += `<div class="gantt-row" data-epic-id="${epic.id}" style="display: flex; height: ${ganttRowHeight}px; border-bottom: 1px solid var(--border); min-width: ${totalWidth}px;">`;
        html += `<div class="gantt-label gantt-epic-header" data-epic-id="${epic.id}" style="width: 420px; padding: 8px; border-right: 1px solid var(--border); font-weight: 600; background: var(--card); cursor: pointer; user-select: none; display: flex; align-items: center; gap: 6px; font-size: 12px;">`;
        html += `<span class="gantt-expand-icon" style="font-size: 10px; color: var(--muted);">${expandIcon}</span>`;
        html += `<span style="font-size: 12px;">${epic.key}: ${epic.summary}</span>`;
        html += `</div>`;
        html += `<div class="gantt-bar-container" style="position: relative; flex: 1; height: 100%;">`;
        
        if (epicStart !== null && epicEnd !== null) {
          const left = epicStart * ganttDayWidth;
          const width = (epicEnd - epicStart + 1) * ganttDayWidth;
          html += `<div class="gantt-bar epic-bar" style="position: absolute; left: ${left}px; top: 8px; width: ${width}px; height: 24px; background: var(--primary); opacity: 0.3; border-radius: 4px;"></div>`;
        }
        
        html += `</div></div>`;
        rowIndex++;
        
        // Задачи эпика (скрыты по умолчанию)
        epic.tasks.forEach(task => {
          const taskDisplay = isExpanded ? 'flex' : 'none';
          const taskStart = getTaskStartDate(task);
          const taskEnd = getTaskEndDate(task);
          
          html += `<div class="gantt-row gantt-task-row" data-task-id="${task.id}" data-epic-id="${epic.id}" style="display: ${taskDisplay}; height: ${ganttRowHeight}px; border-bottom: 1px solid var(--border); min-width: ${totalWidth}px;">`;
          html += `<div class="gantt-label" style="width: 420px; padding: 8px; border-right: 1px solid var(--border); background: var(--card); font-size: 12px;">`;
          html += `${task.key}: ${task.summary}`;
          html += `</div>`;
          html += `<div class="gantt-bar-container" style="position: relative; flex: 1; height: 100%;">`;
          
          if (taskStart !== null && taskEnd !== null) {
            const left = taskStart * ganttDayWidth;
            const width = (taskEnd - taskStart + 1) * ganttDayWidth;
            html += `<div class="gantt-bar task-bar" draggable="true" data-task-id="${task.id}" style="position: absolute; left: ${left}px; top: 8px; width: ${width}px; height: 24px; background: var(--primary); border-radius: 4px; cursor: move; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">`;
            html += `${task.originalEstimate}ч`;
            html += `<div class="connection-point left" style="position: absolute; left: -4px; top: 50%; transform: translateY(-50%); width: 8px; height: 8px; background: var(--primary); border-radius: 50%; cursor: crosshair; z-index: 10;"></div>`;
            html += `<div class="connection-point right" style="position: absolute; right: -4px; top: 50%; transform: translateY(-50%); width: 8px; height: 8px; background: var(--primary); border-radius: 50%; cursor: crosshair; z-index: 10;"></div>`;
            html += `<div class="connection-point top" style="position: absolute; top: -4px; left: 50%; transform: translateX(-50%); width: 8px; height: 8px; background: var(--primary); border-radius: 50%; cursor: crosshair; z-index: 10;"></div>`;
            html += `<div class="connection-point bottom" style="position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 8px; height: 8px; background: var(--primary); border-radius: 50%; cursor: crosshair; z-index: 10;"></div>`;
            html += `</div>`;
          }
          
          html += `</div></div>`;
          rowIndex++;
        });
      });
      
      tasksEl.innerHTML = html;
      
      // Добавляем обработчики для drag & drop
      setupGanttDragDrop();
      
      // Добавляем обработчики для связей
      setupGanttConnections();
      
      // Добавляем обработчики для сворачивания/разворачивания эпиков
      setupGanttEpicToggle();
      
      // Рендерим связи после небольшой задержки, чтобы DOM обновился
      setTimeout(() => {
        renderGanttConnections();
      }, 100);
    }
    
    // Настройка обработчиков для сворачивания/разворачивания эпиков
    function setupGanttEpicToggle() {
      const epicHeaders = document.querySelectorAll('.gantt-epic-header');
      epicHeaders.forEach(header => {
        header.addEventListener('click', function(e) {
          e.stopPropagation();
          const epicId = this.getAttribute('data-epic-id');
          toggleEpic(epicId);
        });
      });
    }
    
    // Переключение состояния эпика (свернуть/развернуть)
    function toggleEpic(epicId) {
      // Переключаем состояние
      ganttExpandedEpics[epicId] = !ganttExpandedEpics[epicId];
      
      // Находим все задачи этого эпика
      const taskRows = document.querySelectorAll(`.gantt-task-row[data-epic-id="${epicId}"]`);
      const isExpanded = ganttExpandedEpics[epicId];
      
      // Показываем/скрываем задачи
      taskRows.forEach(row => {
        row.style.display = isExpanded ? 'flex' : 'none';
      });
      
      // Обновляем иконку
      const epicHeader = document.querySelector(`.gantt-epic-header[data-epic-id="${epicId}"]`);
      if (epicHeader) {
        const icon = epicHeader.querySelector('.gantt-expand-icon');
        if (icon) {
          icon.textContent = isExpanded ? '▼' : '▶';
        }
      }
      
      // Перерисовываем связи после изменения видимости
      setTimeout(() => {
        renderGanttConnections();
      }, 50);
    }
    
    // Получение даты начала эпика
    function getEpicStartDate(epic) {
      if (!epic.tasks || epic.tasks.length === 0) return null;
      
      let minStart = null;
      epic.tasks.forEach(task => {
        const start = getTaskStartDate(task);
        if (start !== null && (minStart === null || start < minStart)) {
          minStart = start;
        }
      });
      
      return minStart;
    }
    
    // Получение даты окончания эпика
    function getEpicEndDate(epic) {
      if (!epic.tasks || epic.tasks.length === 0) return null;
      
      let maxEnd = null;
      epic.tasks.forEach(task => {
        const end = getTaskEndDate(task);
        if (end !== null && (maxEnd === null || end > maxEnd)) {
          maxEnd = end;
        }
      });
      
      return maxEnd;
    }
    
    // Основная функция рендеринга
    function renderGantt() {
      renderGanttCalendar();
      renderGanttTasks();
    }
    
    // Настройка drag & drop
    function setupGanttDragDrop() {
      const taskBars = document.querySelectorAll('.task-bar');
      taskBars.forEach(bar => {
        bar.addEventListener('dragstart', handleGanttDragStart);
        bar.addEventListener('drag', handleGanttDrag);
        bar.addEventListener('dragend', handleGanttDragEnd);
      });
      
      const containers = document.querySelectorAll('.gantt-bar-container');
      containers.forEach(container => {
        container.addEventListener('dragover', handleGanttDragOver);
        container.addEventListener('drop', handleGanttDrop);
      });
    }
    
    function handleGanttDragStart(e) {
      ganttDraggedTask = e.target;
      e.target.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleGanttDrag(e) {
      // Обновляем позицию при перетаскивании
    }
    
    function handleGanttDragEnd(e) {
      if (ganttDraggedTask) {
        ganttDraggedTask.style.opacity = '1';
        ganttDraggedTask = null;
      }
    }
    
    function handleGanttDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }
    
    function handleGanttDrop(e) {
      e.preventDefault();
      
      if (!ganttDraggedTask) return;
      
      const container = e.currentTarget;
      const rect = container.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const dayIndex = Math.floor(x / ganttDayWidth);
      
      if (dayIndex < 0 || dayIndex >= ganttCalendarDays.length) return;
      
      const taskId = ganttDraggedTask.getAttribute('data-task-id');
      if (!ganttState.tasks) {
        ganttState.tasks = {};
      }
      
      if (!ganttState.tasks[taskId]) {
        ganttState.tasks[taskId] = {};
      }
      
      ganttState.tasks[taskId].startDate = dayIndex;
      
      // Перемещаем связанные задачи
      moveConnectedTasks(taskId, dayIndex);
      
      // Перерисовываем
      renderGantt();
      
      // Показываем кнопку сохранения
      document.getElementById('gantt-save').style.display = 'inline-block';
      
      // Обновляем связи после перерисовки
      setTimeout(() => {
        renderGanttConnections();
      }, 100);
    }
    
    // Перемещение связанных задач
    function moveConnectedTasks(taskId, newStartDate) {
      if (!ganttState.connections) return;
      
      const oldStartDate = ganttState.tasks[taskId]?.startDate;
      if (oldStartDate === null || oldStartDate === undefined) return;
      
      const offset = newStartDate - oldStartDate;
      
      ganttState.connections.forEach(conn => {
        let otherTaskId = null;
        if (conn.from === taskId) {
          otherTaskId = conn.to;
        } else if (conn.to === taskId) {
          otherTaskId = conn.from;
        }
        
        if (otherTaskId && ganttState.tasks[otherTaskId]) {
          const currentStart = ganttState.tasks[otherTaskId].startDate;
          if (currentStart !== null && currentStart !== undefined) {
            ganttState.tasks[otherTaskId].startDate = currentStart + offset;
          }
        }
      });
    }
    
    // Настройка связей между задачами
    function setupGanttConnections() {
      const connectionPoints = document.querySelectorAll('.connection-point');
      connectionPoints.forEach(point => {
        point.addEventListener('click', handleConnectionPointClick);
      });
    }
    
    function handleConnectionPointClick(e) {
      e.stopPropagation();
      
      if (!ganttConnectionMode) {
        // Начинаем создание связи
        const taskBar = e.target.closest('.task-bar');
        const taskId = taskBar.getAttribute('data-task-id');
        const pointType = e.target.classList.contains('left') ? 'left' :
                         e.target.classList.contains('right') ? 'right' :
                         e.target.classList.contains('top') ? 'top' : 'bottom';
        
        ganttConnectionMode = {
          fromTask: taskId,
          fromPoint: pointType,
        };
        
        e.target.style.background = 'var(--success)';
      } else {
        // Завершаем создание связи
        const taskBar = e.target.closest('.task-bar');
        const toTaskId = taskBar.getAttribute('data-task-id');
        const toPointType = e.target.classList.contains('left') ? 'left' :
                           e.target.classList.contains('right') ? 'right' :
                           e.target.classList.contains('top') ? 'top' : 'bottom';
        
        if (ganttConnectionMode.fromTask !== toTaskId) {
          if (!ganttState.connections) {
            ganttState.connections = [];
          }
          
          ganttState.connections.push({
            from: ganttConnectionMode.fromTask,
            fromPoint: ganttConnectionMode.fromPoint,
            to: toTaskId,
            toPoint: toPointType,
          });
          
          // Сбрасываем выделение
          document.querySelectorAll('.connection-point').forEach(p => {
            p.style.background = 'var(--primary)';
          });
          
          renderGantt();
          document.getElementById('gantt-save').style.display = 'inline-block';
        }
        
        ganttConnectionMode = null;
      }
    }
    
    // Рендеринг связей
    function renderGanttConnections() {
      const svg = document.getElementById('gantt-connections');
      if (!svg || !ganttState || !ganttState.connections) return;
      
      svg.innerHTML = '';
      
      // Добавляем маркер для стрелок один раз
      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
      marker.setAttribute('id', 'arrowhead');
      marker.setAttribute('markerWidth', '10');
      marker.setAttribute('markerHeight', '10');
      marker.setAttribute('refX', '9');
      marker.setAttribute('refY', '3');
      marker.setAttribute('orient', 'auto');
      const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
      polygon.setAttribute('points', '0 0, 10 3, 0 6');
      polygon.setAttribute('fill', 'var(--primary)');
      marker.appendChild(polygon);
      defs.appendChild(marker);
      svg.appendChild(defs);
      
      ganttState.connections.forEach(conn => {
        const fromBar = document.querySelector(`.task-bar[data-task-id="${conn.from}"]`);
        const toBar = document.querySelector(`.task-bar[data-task-id="${conn.to}"]`);
        
        if (!fromBar || !toBar) return;
        
        const container = document.getElementById('gantt-container');
        if (!container) return;
        
        const tasksContainer = document.getElementById('gantt-tasks');
        if (!tasksContainer) return;
        
        const fromRect = fromBar.getBoundingClientRect();
        const toRect = toBar.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        const tasksRect = tasksContainer.getBoundingClientRect();
        
        let x1, y1, x2, y2;
        
        // Вычисляем координаты точек относительно SVG (который находится в контейнере)
        // SVG находится на том же уровне, что и tasks, поэтому используем containerRect
        if (conn.fromPoint === 'left') {
          x1 = fromRect.left - containerRect.left;
          y1 = fromRect.top + fromRect.height / 2 - containerRect.top;
        } else if (conn.fromPoint === 'right') {
          x1 = fromRect.right - containerRect.left;
          y1 = fromRect.top + fromRect.height / 2 - containerRect.top;
        } else if (conn.fromPoint === 'top') {
          x1 = fromRect.left + fromRect.width / 2 - containerRect.left;
          y1 = fromRect.top - containerRect.top;
        } else {
          x1 = fromRect.left + fromRect.width / 2 - containerRect.left;
          y1 = fromRect.bottom - containerRect.top;
        }
        
        if (conn.toPoint === 'left') {
          x2 = toRect.left - containerRect.left;
          y2 = toRect.top + toRect.height / 2 - containerRect.top;
        } else if (conn.toPoint === 'right') {
          x2 = toRect.right - containerRect.left;
          y2 = toRect.top + toRect.height / 2 - containerRect.top;
        } else if (conn.toPoint === 'top') {
          x2 = toRect.left + toRect.width / 2 - containerRect.left;
          y2 = toRect.top - containerRect.top;
        } else {
          x2 = toRect.left + toRect.width / 2 - containerRect.left;
          y2 = toRect.bottom - containerRect.top;
        }
        
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x1);
        line.setAttribute('y1', y1);
        line.setAttribute('x2', x2);
        line.setAttribute('y2', y2);
        line.setAttribute('stroke', 'var(--primary)');
        line.setAttribute('stroke-width', '2');
        line.setAttribute('marker-end', 'url(#arrowhead)');
        
        svg.appendChild(line);
      });
    }
    
    // Автоматическое распределение задач
    function autoDistributeTasks() {
      if (!ganttData) return;
      
      // Сортируем эпики по приоритету
      const priorityOrder = { 'Highest': 0, 'High': 1, 'Medium': 2, 'Low': 3, 'Lowest': 4 };
      const sortedEpics = [...ganttData].sort((a, b) => {
        const aPriority = priorityOrder[a.priority] ?? 99;
        const bPriority = priorityOrder[b.priority] ?? 99;
        return aPriority - bPriority;
      });
      
      // Группируем задачи по исполнителям
      // Если у задачи несколько исполнителей, она добавляется в группы всех исполнителей
      const tasksByAssignee = {};
      sortedEpics.forEach(epic => {
        epic.tasks.forEach(task => {
          if (task.assignees && task.assignees.length > 0) {
            task.assignees.forEach(assignee => {
              if (!tasksByAssignee[assignee]) {
                tasksByAssignee[assignee] = [];
              }
              tasksByAssignee[assignee].push({
                ...task,
                epicPriority: epic.priority,
              });
            });
          } else {
            // Если нет исполнителей, добавляем в общую группу
            const noAssigneeKey = '__no_assignee__';
            if (!tasksByAssignee[noAssigneeKey]) {
              tasksByAssignee[noAssigneeKey] = [];
            }
            tasksByAssignee[noAssigneeKey].push({
              ...task,
              epicPriority: epic.priority,
            });
          }
        });
      });
      
      // Распределяем задачи по исполнителям
      if (!ganttState.tasks) {
        ganttState.tasks = {};
      }
      
      const assigneeTimelines = {};
      
      Object.keys(tasksByAssignee).forEach(assignee => {
        assigneeTimelines[assignee] = [];
        const tasks = tasksByAssignee[assignee];
        
        // Сортируем задачи по приоритету эпика
        tasks.sort((a, b) => {
          const aPriority = priorityOrder[a.epicPriority] ?? 99;
          const bPriority = priorityOrder[b.epicPriority] ?? 99;
          return aPriority - bPriority;
        });
        
        let currentDate = 0;
        tasks.forEach(task => {
          const workingDays = Math.ceil(task.originalEstimate / 8);
          
          // Пропускаем выходные
          while (currentDate < ganttCalendarDays.length && ganttCalendarDays[currentDate].isWeekend) {
            currentDate++;
          }
          
          if (currentDate < ganttCalendarDays.length) {
            ganttState.tasks[task.id] = {
              startDate: currentDate,
            };
            
            // Вычисляем дату окончания
            let daysAdded = 0;
            let endDate = currentDate;
            while (daysAdded < workingDays && endDate < ganttCalendarDays.length) {
              if (!ganttCalendarDays[endDate].isWeekend) {
                daysAdded++;
              }
              if (daysAdded < workingDays) {
                endDate++;
              }
            }
            
            assigneeTimelines[assignee].push({
              taskId: task.id,
              start: currentDate,
              end: endDate,
            });
            
            currentDate = endDate + 1;
          }
        });
      });
      
      ganttAutoMode = true;
      document.getElementById('gantt-remove-auto').style.display = 'inline-block';
      document.getElementById('gantt-save').style.display = 'inline-block';
      
      renderGantt();
      
      // Обновляем связи после перерисовки
      setTimeout(() => {
        renderGanttConnections();
      }, 100);
    }
    
    // Убрать автоматическое распределение
    function removeAutoDistribution() {
      if (!ganttState.tasks) return;
      
      // Удаляем сохраненные позиции задач
      ganttState.tasks = {};
      ganttAutoMode = false;
      
      document.getElementById('gantt-remove-auto').style.display = 'none';
      document.getElementById('gantt-save').style.display = 'inline-block';
      
      renderGantt();
    }
    
    // Сохранение состояния
    async function saveGanttState() {
      try {
        const response = await fetch(`/api/teams/${teamId}/gantt/state`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            state: ganttState,
            autoMode: ganttAutoMode,
          }),
        });
        
        const result = await response.json();
        if (result.success) {
          document.getElementById('gantt-save').style.display = 'none';
        } else {
          console.error('Ошибка сохранения:', result.error);
        }
      } catch (e) {
        console.error('Ошибка при сохранении:', e);
      }
    }
    
    // Загрузка состояния
    async function loadGanttState() {
      try {
        const response = await fetch(`/api/teams/${teamId}/gantt/state`);
        const result = await response.json();
        
        if (result.success && result.data) {
          ganttState = result.data.state || { tasks: {}, connections: [] };
          ganttAutoMode = result.data.autoMode || false;
        } else {
          ganttState = { tasks: {}, connections: [] };
          ganttAutoMode = false;
        }
      } catch (e) {
        console.error('Ошибка загрузки состояния:', e);
        ganttState = { tasks: {}, connections: [] };
        ganttAutoMode = false;
      }
    }
  </script>
</body>
</html>


