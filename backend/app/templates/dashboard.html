<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–î–∞—à–±–æ—Ä–¥ ‚Äî {{ team.name }}</title>
  <link rel="stylesheet" href="/static/styles.css?v=2">
  <style>
    /* –ß–µ—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–µ–º—Å—è —Å–ø–∏—Å–∫–µ —Å–µ–ª–µ–∫—Ç–æ–≤ */
    #days option,
    #done-user-select option,
    #done-period-select option,
    #no-release-user-select option,
    #filter-type-select option,
    #filter-user-select option,
    #filter-period-select option {
      color: #000;
      background-color: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div>
        <a class="muted" href="/teams/{{ team.id }}">&larr; –Ω–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</a>
        <h1>–î–∞—à–±–æ—Ä–¥: {{ team.name }}</h1>
        <p class="muted">–ú–µ—Ç—Ä–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–æ–º–∞–Ω–¥—ã</p>
      </div>
    </header>

    <!-- –¢–∞–±—ã -->
    <div class="card" style="margin-bottom: 0; border-bottom: none; border-radius: 14px 14px 0 0; padding: 0; max-width: 980px; margin-left: auto; margin-right: auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div style="display: flex; gap: 0; border-bottom: 1px solid var(--border);">
        <button id="tab-time" class="tab-button active" onclick="switchTab('time')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid var(--primary); cursor: pointer; font-weight: 600;">
          –°–ø–∏—Å–∞–Ω–æ –≤—Ä–µ–º–µ–Ω–∏
        </button>
        <button id="tab-epics" class="tab-button" onclick="switchTab('epics')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted);">
          –≠–ø–∏–∫–∏
        </button>
        <button id="tab-releases" class="tab-button" onclick="switchTab('releases')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted);">
          –†–µ–ª–∏–∑—ã
        </button>
        <button id="tab-filters" class="tab-button" onclick="switchTab('filters')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted);">
          –§–∏–ª—å—Ç—Ä—ã
        </button>
        <button id="tab-improve" class="tab-button" onclick="switchTab('improve')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted);">
          Improve
        </button>
        <button id="tab-gantt" class="tab-button" onclick="switchTab('gantt')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted);">
          –ì–∞–Ω—Ç
        </button>
        <button id="tab-todo" class="tab-button" onclick="switchTab('todo')" style="padding: 12px 20px; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 600; color: var(--muted);">
          Todo
        </button>
      </div>
    </div>

    <!-- –¢–∞–±: –°–ø–∏—Å–∞–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ -->
    <div id="tab-content-time" class="tab-content" style="max-width: 980px; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 16px; width: 100%; box-sizing: border-box;">
        <div class="toolbar">
          <h2>–°–ø–∏—Å–∞–Ω–æ –≤—Ä–µ–º–µ–Ω–∏</h2>
          <div style="display: flex; gap: 10px; align-items: center;">
            <label for="days" class="muted">–ü–µ—Ä–∏–æ–¥:</label>
            <select id="days" class="input" style="width: auto; padding: 6px 10px;" onchange="window.location.href='?days=' + this.value">
              <option value="today" {% if days == 'today' %}selected{% endif %}>–°–µ–≥–æ–¥–Ω—è</option>
              <option value="yesterday" {% if days == 'yesterday' %}selected{% endif %}>–í—á–µ—Ä–∞</option>
              <option value="8" {% if days == '8' %}selected{% endif %}>–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 8 –¥–Ω–µ–π</option>
            </select>
          </div>
        </div>

      <div id="worklog-loading" style="text-align: center; padding: 20px;">
        <p class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
      </div>
      <div id="worklog-error" style="display: none;"></div>
      <div id="worklog-content" style="display: none;">
        <div style="overflow-x: auto; margin: 0 -16px; padding: 0 16px;">
          <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
            <thead>
              <tr style="border-bottom: 1px solid var(--border);">
                <th style="text-align: left; padding: 10px;">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                <th style="text-align: right; padding: 10px;">–ß–∞—Å–æ–≤</th>
                <th style="text-align: right; padding: 10px;">–ó–∞–ø–∏—Å–µ–π</th>
              </tr>
            </thead>
            <tbody id="worklog-tbody">
            </tbody>
            <tfoot id="worklog-tfoot">
            </tfoot>
          </table>
        </div>
      </div>
    </div>
    </div>

    <!-- –¢–∞–±: –≠–ø–∏–∫–∏ -->
    <div id="tab-content-epics" class="tab-content" style="display: none; max-width: 980px; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 16px; width: 100%; box-sizing: border-box;">
        <div class="toolbar">
          <h2>–≠–ø–∏–∫–∏</h2>
        </div>

        <div id="epics-loading" style="text-align: center; padding: 20px;">
          <p class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
        <div id="epics-error" style="display: none;"></div>
        <div id="epics-content" style="display: none;">
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
              <thead>
                <tr style="border-bottom: 1px solid var(--border);">
                  <th style="text-align: left; padding: 10px;">–ö–ª—é—á</th>
                  <th style="text-align: left; padding: 10px;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th style="text-align: left; padding: 10px;">–°—Ç–∞—Ç—É—Å</th>
                  <th style="text-align: left; padding: 10px;">–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
                  <th style="text-align: left; padding: 10px;">–°–æ–∑–¥–∞–Ω–æ</th>
                </tr>
              </thead>
              <tbody id="epics-tbody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    </div>

    <!-- –¢–∞–±: –†–µ–ª–∏–∑—ã -->
    <div id="tab-content-releases" class="tab-content" style="display: none; max-width: 980px; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 16px; width: 100%; box-sizing: border-box;">
        <div class="toolbar">
          <h2>–†–µ–ª–∏–∑—ã</h2>
        </div>

        <div id="releases-loading" style="text-align: center; padding: 20px;">
          <p class="muted">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
        <div id="releases-error" style="display: none;"></div>
        <div id="releases-content" style="display: none;">
          <div style="overflow-x: auto; max-width: 100%;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 12px; max-width: 100%; table-layout: fixed;">
              <colgroup>
                <col style="width: 60%;">
                <col style="width: 40%;">
              </colgroup>
              <thead>
                <tr style="border-bottom: 1px solid var(--border);">
                  <th style="text-align: left; padding: 10px;">–ù–∞–∑–≤–∞–Ω–∏–µ —ç–ø–∏–∫–∞</th>
                  <th style="text-align: left; padding: 10px;">–î–∞—Ç–∞ —Ä–µ–ª–∏–∑–∞</th>
                </tr>
              </thead>
              <tbody id="releases-tbody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- –¢–∞–±: –§–∏–ª—å—Ç—Ä—ã -->
    <div id="tab-content-filters" class="tab-content" style="display: none; max-width: 980px; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 16px; width: 100%; box-sizing: border-box;">
        <div class="toolbar">
          <h2>–§–∏–ª—å—Ç—Ä—ã –ø–æ –∑–∞–¥–∞—á–∞–º</h2>
        </div>
        
        <div style="display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--muted);">–§–∏–ª—å—Ç—Ä:</label>
            <select id="filter-type-select" class="input" style="width: 100%;" onchange="onFilterTypeChange()">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä</option>
              <option value="done">–ó–∞–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏</option>
              <option value="no-release">–ó–∞–¥–∞—á–∏ –±–µ–∑ —Ä–µ–ª–∏–∑–∞</option>
            </select>
          </div>
          
          <!-- –°–µ–ª–µ–∫—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ —Ñ–∏–ª—å—Ç—Ä–∞) -->
          <div id="filter-user-container" style="flex: 1; min-width: 200px; display: none;">
            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--muted);">–°–æ—Ç—Ä—É–¥–Ω–∏–∫:</label>
            <select id="filter-user-select" class="input" style="width: 100%;" onchange="loadFilterTasks()">
              <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>
            </select>
          </div>
          
          <!-- –°–µ–ª–µ–∫—Ç –ø–µ—Ä–∏–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è "–ó–∞–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏") -->
          <div id="filter-period-container" style="flex: 1; min-width: 200px; display: none;">
            <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--muted);">–ü–µ—Ä–∏–æ–¥:</label>
            <select id="filter-period-select" class="input" style="width: 100%;" onchange="loadFilterTasks()">
              <option value="today">–°–µ–≥–æ–¥–Ω—è</option>
              <option value="yesterday">–í—á–µ—Ä–∞</option>
              <option value="week">–ó–∞ –Ω–µ–¥–µ–ª—é</option>
            </select>
          </div>
        </div>
        
        <div id="filter-loading" style="text-align: center; padding: 40px; color: var(--muted);">
          –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á
        </div>
        <div id="filter-error" style="display: none;"></div>
        <div id="filter-content" style="display: none;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 2px solid var(--border);">
                <th style="padding: 10px; text-align: left; font-weight: 600;">–ó–∞–¥–∞—á–∞</th>
                <th style="padding: 10px; text-align: left; font-weight: 600;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th id="filter-th-extra" style="padding: 10px; text-align: left; font-weight: 600; display: none;"></th>
                <th style="padding: 10px; text-align: left; font-weight: 600;">–î–∞—Ç–∞</th>
              </tr>
            </thead>
            <tbody id="filter-tbody">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –¢–∞–±: Improve -->
    <div id="tab-content-improve" class="tab-content" style="display: none; max-width: 980px; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 16px; width: 100%; box-sizing: border-box;">
        <div class="toolbar">
          <h2>Improve</h2>
        </div>
        
        <div id="improve-loading" style="text-align: center; padding: 40px; color: var(--muted);">
          –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>
        <div id="improve-error" style="display: none;"></div>
        <div id="improve-content" style="display: none;">
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-top: 12px;">
              <thead>
                <tr style="border-bottom: 2px solid var(--border);">
                  <th style="padding: 10px; text-align: left; font-weight: 600;">–ö–ª—é—á</th>
                  <th style="padding: 10px; text-align: left; font-weight: 600;">–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                  <th style="padding: 10px; text-align: left; font-weight: 600;">–°–æ–∑–¥–∞–Ω–æ</th>
                </tr>
              </thead>
              <tbody id="improve-tbody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- –¢–∞–±: –ì–∞–Ω—Ç -->
    <div id="tab-content-gantt" class="tab-content" style="display: none; max-width: 100%; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 16px; width: 100%; box-sizing: border-box;">
        <div class="toolbar" style="margin-bottom: 16px;">
          <h2>–î–∏–∞–≥—Ä–∞–º–º–∞ –ì–∞–Ω—Ç–∞</h2>
          <div style="display: flex; gap: 10px;">
            <button id="gantt-auto-distribute" class="button" onclick="autoDistributeTasks()" style="display: none;">
              –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            </button>
            <button id="gantt-remove-auto" class="button" onclick="removeAutoDistribution()" style="display: none;">
              –£–±—Ä–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
            </button>
            <button id="gantt-save" class="button primary" onclick="saveGanttState()" style="display: none;">
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
          </div>
        </div>
        
        <div id="gantt-loading" style="text-align: center; padding: 40px; color: var(--muted);">
          –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...
        </div>
        <div id="gantt-error" style="display: none;"></div>
        <div id="gantt-content" style="display: none; overflow-x: auto;">
          <div id="gantt-container" style="position: relative; min-width: 100%;">
            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä–Ω–∞—è —Å–µ—Ç–∫–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            <div id="gantt-calendar" style="position: sticky; top: 0; z-index: 10; background: var(--card); border-bottom: 2px solid var(--border);"></div>
            <!-- –≠–ø–∏–∫–∏ –∏ –∑–∞–¥–∞—á–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            <div id="gantt-tasks" style="position: relative;">
            </div>
            <!-- SVG –¥–ª—è —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏ -->
            <svg id="gantt-connections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; overflow: visible;"></svg>
          </div>
          </div>
        </div>
      </div>
    </div>

    <!-- –¢–∞–±: Todo -->
    <div id="tab-content-todo" class="tab-content" style="display: none; max-width: 100%; margin: 0 auto; box-sizing: border-box; width: calc(100% - 56px); height: calc(100vh - 200px);">
      <div class="card" style="border-radius: 0 0 14px 14px; margin-top: 0; padding: 0; width: 100%; box-sizing: border-box; height: 100%; display: flex; flex-direction: column;">
        <div id="todo-container" style="display: flex; flex: 1; overflow: hidden;">
          <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å - —Å–ø–∏—Å–∫–∏ -->
          <div id="todo-sidebar" style="width: 280px; border-right: 1px solid var(--border); background: var(--card); overflow-y: auto; display: flex; flex-direction: column;">
            <div style="padding: 16px; border-bottom: 1px solid var(--border);">
              <h2 style="margin: 0; font-size: 20px; font-weight: 600;">–°–ø–∏—Å–∫–∏</h2>
            </div>
            <div id="todo-lists" style="flex: 1; overflow-y: auto; padding: 8px 0;">
              <!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–ø–∏—Å–∫–∏ -->
              <div class="todo-list-item todo-list-system active" data-list-type="my-day" onclick="selectTodoList('my-day')">
                <span class="todo-list-icon">üìÖ</span>
                <span class="todo-list-name">–ú–æ–π –¥–µ–Ω—å</span>
              </div>
              <div class="todo-list-item todo-list-system" data-list-type="important" onclick="selectTodoList('important')">
                <span class="todo-list-icon">‚≠ê</span>
                <span class="todo-list-name">–í–∞–∂–Ω–æ</span>
              </div>
              <div class="todo-list-item todo-list-system" data-list-type="planned" onclick="selectTodoList('planned')">
                <span class="todo-list-icon">üìÜ</span>
                <span class="todo-list-name">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</span>
              </div>
              <div class="todo-list-item todo-list-system" data-list-type="all" onclick="selectTodoList('all')">
                <span class="todo-list-icon">üìã</span>
                <span class="todo-list-name">–í—Å–µ</span>
              </div>
              <div class="todo-list-item todo-list-system" data-list-type="completed" onclick="selectTodoList('completed')">
                <span class="todo-list-icon">‚úÖ</span>
                <span class="todo-list-name">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
              </div>
              
              <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
              <div style="margin: 8px 16px; border-top: 1px solid var(--border);"></div>
              
              <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–ø–∏—Å–∫–∏ -->
              <div id="todo-custom-lists"></div>
              
              <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ -->
              <div class="todo-list-item todo-list-add" onclick="showAddListDialog()" style="color: var(--primary); cursor: pointer;">
                <span class="todo-list-icon">+</span>
                <span class="todo-list-name">–ù–æ–≤—ã–π —Å–ø–∏—Å–æ–∫</span>
              </div>
            </div>
          </div>
          
          <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –æ–±–ª–∞—Å—Ç—å - –∑–∞–¥–∞—á–∏ -->
          <div id="todo-main" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
            <div id="todo-header" style="padding: 16px; border-bottom: 1px solid var(--border);">
              <h2 id="todo-list-title" style="margin: 0; font-size: 20px; font-weight: 600;">–ú–æ–π –¥–µ–Ω—å</h2>
              <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
                <input type="text" id="todo-search" placeholder="–ü–æ–∏—Å–∫ –∑–∞–¥–∞—á..." style="flex: 1; padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white;" onkeyup="filterTodoTasks()">
                <select id="todo-filter-priority" style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: white; color: black;" onchange="filterTodoTasks()">
                  <option value="">–í—Å–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã</option>
                  <option value="important">–í–∞–∂–Ω–æ</option>
                  <option value="normal">–û–±—ã—á–Ω—ã–π</option>
                </select>
              </div>
            </div>
            <div id="todo-tasks-container" style="flex: 1; overflow-y: auto; padding: 16px;">
              <div id="todo-tasks-list"></div>
              <div id="todo-add-task" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                <textarea id="todo-new-task-input" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É" style="width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); font-size: 14px; color: white; resize: vertical; min-height: 40px;" onkeydown="handleTodoTaskInput(event)"></textarea>
              </div>
            </div>
          </div>
          
          <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å - –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏ -->
          <div id="todo-details" style="width: 320px; border-left: 1px solid var(--border); background: var(--card); overflow-y: auto; display: none; padding: 16px;">
            <div id="todo-details-content">
              <h3 id="todo-details-title" style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: white;">–î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏</h3>
              
              <!-- –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è -->
              <div style="margin-bottom: 16px; padding: 8px; background: var(--hover); border-radius: 6px;">
                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: rgba(255, 255, 255, 0.7);">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</label>
                <span id="todo-details-created" style="font-size: 14px; color: white;"></span>
              </div>
              
              <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: rgba(255, 255, 255, 0.7);">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" id="todo-details-name" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white;" onchange="saveTodoTaskDetails()">
              </div>
              
              <!-- –°—Ç–∞—Ç—É—Å -->
              <div style="margin-bottom: 16px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                  <input type="checkbox" id="todo-details-completed" onchange="saveTodoTaskDetails()">
                  <span style="font-size: 14px; color: white;">–í—ã–ø–æ–ª–Ω–µ–Ω–∞</span>
                </label>
              </div>
              
              <!-- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç -->
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: rgba(255, 255, 255, 0.7);">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                <select id="todo-details-priority" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white;" onchange="saveTodoTaskDetails()">
                  <option value="normal" style="background: var(--card); color: white;">–û–±—ã—á–Ω—ã–π</option>
                  <option value="important" style="background: var(--card); color: white;">–í–∞–∂–Ω–æ</option>
                </select>
              </div>
              
              <!-- –î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è -->
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: rgba(255, 255, 255, 0.7);">–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                <input type="date" id="todo-details-due-date" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white;" onchange="saveTodoTaskDetails()">
              </div>
              
              <!-- –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ -->
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: rgba(255, 255, 255, 0.7);">–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ</label>
                <input type="datetime-local" id="todo-details-reminder" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white;" onchange="saveTodoTaskDetails()">
              </div>
              
              <!-- –ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ -->
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: rgba(255, 255, 255, 0.7);">–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</label>
                <select id="todo-details-repeat" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white;" onchange="saveTodoTaskDetails()">
                  <option value="" style="background: var(--card); color: white;">–ù–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å</option>
                  <option value="daily" style="background: var(--card); color: white;">–ï–∂–µ–¥–Ω–µ–≤–Ω–æ</option>
                  <option value="weekly" style="background: var(--card); color: white;">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
                  <option value="monthly" style="background: var(--card); color: white;">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
                </select>
              </div>
              
              <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 4px; font-size: 12px; color: var(--muted);">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="todo-details-notes" rows="4" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white; resize: vertical;" onchange="saveTodoTaskDetails()" placeholder="–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..."></textarea>
              </div>
              
              <!-- –ü–æ–¥–∑–∞–¥–∞—á–∏ -->
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-size: 12px; color: rgba(255, 255, 255, 0.7);">–ü–æ–¥–∑–∞–¥–∞—á–∏</label>
                <div id="todo-details-subtasks"></div>
                <button onclick="addTodoSubtask()" style="margin-top: 8px; padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–∑–∞–¥–∞—á—É</button>
              </div>
              
              <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
              <button onclick="deleteTodoTask()" style="width: 100%; padding: 8px; background: #ff5b5b; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É</button>
            </div>
          </div>
        </div>
      </div>
    </div>

  <script>
    // –ó–Ω–∞—á–µ–Ω–∏—è –∏–∑ Jinja –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ —Å—Ç—Ä–æ–∫–∏, —á—Ç–æ–±—ã –ª–∏–Ω—Ç–µ—Ä JS –Ω–µ –ª–æ–º–∞–ª—Å—è –Ω–∞ "{ { ... } }"
    const days = JSON.parse('{{ days|tojson }}');
    const teamId = Number('{{ team.id }}');
    const isCustom = ('{{ "true" if is_custom else "false" }}' === 'true');
    
    async function loadWorklog() {
      const loading = document.getElementById('worklog-loading');
      const errorDiv = document.getElementById('worklog-error');
      const content = document.getElementById('worklog-content');
      const tbody = document.getElementById('worklog-tbody');
      const tfoot = document.getElementById('worklog-tfoot');
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 –º–∏–Ω—É—Ç—ã
        let response;
        try {
          response = await fetch(`/api/teams/${teamId}/worklog?days=${days}${isCustom ? "&custom=1" : ""}`, {
            signal: controller.signal
          });
          clearTimeout(timeoutId);
        } catch (fetchError) {
          clearTimeout(timeoutId);
          if (fetchError.name === 'AbortError') {
            throw new Error('–ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è');
          }
          throw fetchError;
        }
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        loading.style.display = 'none';
        
        if (!result.success) {
          errorDiv.innerHTML = `<div class="card error"><p><b>–û—à–∏–±–∫–∞:</b> ${result.error}</p></div>`;
          errorDiv.style.display = 'block';
          return;
        }
        
        const data = result.data || [];
        if (data.length === 0) {
          errorDiv.innerHTML = '<p class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Å–ø–∏—Å–∞–Ω–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.</p>';
          errorDiv.style.display = 'block';
          return;
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        let html = '';
        let totalHours = 0;
        let totalEntries = 0;
        
        data.forEach((item, idx) => {
          totalHours += item.total_hours;
          totalEntries += item.entries.length;
          html += `
            <tr style="border-bottom: 1px solid var(--border); cursor: pointer;" onclick="toggleDetails(${idx})">
              <td style="padding: 10px;">
                <div style="font-weight: 600;">${escapeHtml(item.user_name)}</div>
                <div class="muted" style="font-size: 12px;">${escapeHtml(item.user_account_id)}</div>
              </td>
              <td style="text-align: right; padding: 10px; font-weight: 600;">
                ${item.total_hours.toFixed(1)} —á
              </td>
              <td style="text-align: right; padding: 10px; color: var(--muted);">
                ${item.entries.length}
              </td>
            </tr>
            <tr id="details-${idx}" style="display: none; background: rgba(0,0,0,0.1);">
              <td colspan="3" style="padding: 10px 10px 10px 30px;">
                <div style="font-size: 13px;">
                  ${formatEntries(item.entries, days)}
                </div>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
        tfoot.innerHTML = `
          <tr style="border-top: 2px solid var(--border); font-weight: 600;">
            <td style="padding: 10px;">–í—Å–µ–≥–æ</td>
            <td style="text-align: right; padding: 10px;">${totalHours.toFixed(1)} —á</td>
            <td style="text-align: right; padding: 10px;">${totalEntries}</td>
          </tr>
        `;
        
        content.style.display = 'block';
      } catch (e) {
        loading.style.display = 'none';
        let errorMsg = e.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        if (e.name === 'AbortError') {
          errorMsg = '–ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (3 –º–∏–Ω—É—Ç—ã). –í–æ–∑–º–æ–∂–Ω–æ, Jira API –º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏–æ–¥.';
        } else if (e.message && e.message.includes('HTTP')) {
          errorMsg = e.message;
        }
        errorDiv.innerHTML = `<div class="card error"><p><b>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</b> ${escapeHtml(errorMsg)}</p><p style="font-size: 12px; color: var(--muted); margin-top: 8px;">–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Jira API –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –ø–µ—Ä–∏–æ–¥.</p></div>`;
        errorDiv.style.display = 'block';
        console.error('Worklog loading error:', e);
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    function formatDate(dateStr) {
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º "2025-12-29" –≤ "29.12"
      if (!dateStr) return '';
      const parts = dateStr.split('-');
      if (parts.length === 3) {
        return `${parts[2]}.${parts[1]}`;
      }
      return dateStr;
    }

    function renderWorklogTitle(entry) {
      const key = String(entry.issue_key || '').trim();
      const summary = String(entry.issue_summary || '').trim();
      const title = summary.substring(0, 60) + (summary.length > 60 ? '...' : '');

      if (key) {
        // Jira task: clickable key + title
        const href = 'https://topntop.atlassian.net/browse/' + escapeHtml(key);
        const keyHtml =
          '<a href="' + href + '" target="_blank" ' +
          'style="color: var(--primary); text-decoration: none; font-weight: 700;">' +
          escapeHtml(key) +
          '</a>';
        return keyHtml + (title ? (': ' + escapeHtml(title)) : '');
      }

      // TimePlanner event: just name (no colon, no empty key)
      return escapeHtml(title || summary || '');
    }
    
    function formatEntries(entries, period) {
      // –ï—Å–ª–∏ –ø–µ—Ä–∏–æ–¥ "8 –¥–Ω–µ–π", –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–∞–º
      if (period === '8' || period === 8) {
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–ø–∏—Å–∏ –ø–æ –¥–∞—Ç–∞–º
        const groupedByDate = {};
        entries.forEach(entry => {
          const date = entry.worklog_date || (entry.started ? entry.started.substring(0, 10) : '');
          if (!date) return;
          
          if (!groupedByDate[date]) {
            groupedByDate[date] = {
              date: date,
              entries: [],
              totalSeconds: 0
            };
          }
          groupedByDate[date].entries.push(entry);
          groupedByDate[date].totalSeconds += entry.time_spent_seconds || 0;
        });
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –ø–æ —É–±—ã–≤–∞–Ω–∏—é
        const sortedDates = Object.keys(groupedByDate).sort().reverse();
        
        return sortedDates.map(date => {
          const group = groupedByDate[date];
          const totalHours = group.totalSeconds / 3600;
          
          return `
            <div style="margin-bottom: 16px; padding-bottom: 12px; border-bottom: 2px solid rgba(255,255,255,0.2);">
              <div style="font-weight: 600; margin-bottom: 8px; font-size: 14px;">
                ${formatDate(date)} - ${totalHours.toFixed(1)} —á–∞—Å–æ–≤
              </div>
              <div style="margin-left: 12px;">
                ${group.entries.map(entry => `
                  <div style="padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; justify-content: space-between;">
                      <div>
                        ${renderWorklogTitle(entry)}
                        ${entry.comment ? `<div class="muted" style="margin-top: 4px; font-size: 11px;">${escapeHtml(String(entry.comment).substring(0, 100))}${String(entry.comment).length > 100 ? '...' : ''}</div>` : ''}
                      </div>
                      <div style="text-align: right; margin-left: 12px;">
                        <div>${escapeHtml(entry.time_spent || '')}</div>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }).join('');
      } else {
        // –î–ª—è –¥—Ä—É–≥–∏—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫
        return entries.map(entry => `
          <div style="padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; justify-content: space-between;">
              <div>
                ${renderWorklogTitle(entry)}
                ${entry.comment ? `<div class="muted" style="margin-top: 4px; font-size: 11px;">${escapeHtml(String(entry.comment).substring(0, 100))}${String(entry.comment).length > 100 ? '...' : ''}</div>` : ''}
              </div>
              <div style="text-align: right; margin-left: 12px;">
                <div>${escapeHtml(entry.time_spent || '')}</div>
                <div class="muted" style="font-size: 11px;">
                  ${entry.started ? escapeHtml(entry.started.substring(0, 10)) : ''}
                </div>
              </div>
            </div>
          </div>
        `).join('');
      }
    }
    
    function toggleDetails(index) {
      const row = document.getElementById('details-' + index);
      if (row.style.display === 'none') {
        row.style.display = 'table-row';
      } else {
        row.style.display = 'none';
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
    function switchTab(tabName) {
      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ç–∞–±—ã
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.style.display = 'none';
      });
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
        btn.style.borderBottom = '2px solid transparent';
        btn.style.color = 'var(--muted)';
      });
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–±
      const content = document.getElementById('tab-content-' + tabName);
      const button = document.getElementById('tab-' + tabName);
      if (content) {
        content.style.display = 'block';
      }
      if (button) {
        button.classList.add('active');
        button.style.borderBottom = '2px solid var(--primary)';
        button.style.color = 'inherit';
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–∞ "–≠–ø–∏–∫–∏" –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
      if (tabName === 'epics' && !window.epicsLoaded) {
        loadEpics();
        window.epicsLoaded = true;
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–∞ "–†–µ–ª–∏–∑—ã" –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
      if (tabName === 'releases' && !window.releasesLoaded) {
        loadReleases();
        window.releasesLoaded = true;
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–∞ "–§–∏–ª—å—Ç—Ä—ã" –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
      if (tabName === 'filters') {
        loadFilterUsers();
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–∞ "Improve" –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
      if (tabName === 'improve' && !window.improveLoaded) {
        loadImprove();
        window.improveLoaded = true;
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–∞ "–ì–∞–Ω—Ç" –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
      if (tabName === 'gantt' && !window.ganttLoaded) {
        loadGantt();
        window.ganttLoaded = true;
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–∞–±–∞ "Todo" –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
      if (tabName === 'todo' && !window.todoLoaded) {
        try {
          loadTodo();
        } catch (e) {
          console.error('Todo load error:', e);
        }
        window.todoLoaded = true;
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —ç–ø–∏–∫–æ–≤
    async function loadEpics() {
      const loading = document.getElementById('epics-loading');
      const errorDiv = document.getElementById('epics-error');
      const content = document.getElementById('epics-content');
      const tbody = document.getElementById('epics-tbody');
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 –º–∏–Ω—É—Ç—ã
        const response = await fetch(`/api/teams/${teamId}/epics${isCustom ? "?custom=1" : ""}`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        const result = await response.json();
        
        loading.style.display = 'none';
        
        if (!result.success) {
          errorDiv.innerHTML = `<div class="card error"><p><b>–û—à–∏–±–∫–∞:</b> ${result.error}</p></div>`;
          errorDiv.style.display = 'block';
          return;
        }
        
        const epics = result.data || [];
        if (epics.length === 0) {
          errorDiv.innerHTML = '<p class="muted">–ù–µ—Ç —ç–ø–∏–∫–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>';
          errorDiv.style.display = 'block';
          return;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
        function formatDate(dateStr) {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        let html = '';
        epics.forEach((epic, idx) => {
          html += `
            <tr style="border-bottom: 1px solid var(--border); cursor: pointer;" onclick="toggleEpicIssues(${idx}, '${escapeHtml(epic.key)}')">
              <td style="padding: 10px;">
                <a href="https://topntop.atlassian.net/browse/${escapeHtml(epic.key)}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;" onclick="event.stopPropagation();">
                  ${escapeHtml(epic.key)}
                </a>
              </td>
              <td style="padding: 10px;">${escapeHtml(epic.summary || '')}</td>
              <td style="padding: 10px;">${escapeHtml(epic.status || '')}</td>
              <td style="padding: 10px; color: var(--muted); font-size: 13px;">${formatDate(epic.updated)}</td>
              <td style="padding: 10px; color: var(--muted); font-size: 13px;">${formatDate(epic.created)}</td>
            </tr>
            <tr id="epic-issues-${idx}" style="display: none; background: rgba(0,0,0,0.1);">
              <td colspan="5" style="padding: 10px 10px 10px 30px;">
                <div id="epic-issues-loading-${idx}" style="text-align: center; padding: 10px;">
                  <p class="muted" style="font-size: 13px;">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...</p>
                </div>
                <div id="epic-issues-content-${idx}" style="display: none;">
                  <div style="font-size: 13px;">
                    <table style="width: 100%; border-collapse: collapse;">
                      <thead>
                        <tr style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                          <th style="text-align: left; padding: 8px; font-size: 12px; color: var(--muted);">–ó–∞–¥–∞—á–∞</th>
                          <th style="text-align: left; padding: 8px; font-size: 12px; color: var(--muted);">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</th>
                          <th style="text-align: right; padding: 8px; font-size: 12px; color: var(--muted);">–ò—Å—Ö–æ–¥–Ω–∞—è –æ—Ü–µ–Ω–∫–∞</th>
                          <th style="text-align: right; padding: 8px; font-size: 12px; color: var(--muted);">–°–ø–∏—Å–∞–Ω–æ –≤—Ä–µ–º–µ–Ω–∏</th>
                        </tr>
                      </thead>
                      <tbody id="epic-issues-tbody-${idx}">
                      </tbody>
                    </table>
                  </div>
                </div>
                <div id="epic-issues-error-${idx}" style="display: none;"></div>
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
        content.style.display = 'block';
      } catch (e) {
        loading.style.display = 'none';
        let errorMsg = e.message;
        if (e.name === 'AbortError') {
          errorMsg = '–ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
        }
        errorDiv.innerHTML = `<div class="card error"><p><b>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</b> ${escapeHtml(errorMsg)}</p></div>`;
        errorDiv.style.display = 'block';
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∑–∞–¥–∞—á —ç–ø–∏–∫–∞
    async function toggleEpicIssues(index, epicKey) {
      const row = document.getElementById('epic-issues-' + index);
      const loading = document.getElementById('epic-issues-loading-' + index);
      const content = document.getElementById('epic-issues-content-' + index);
      const errorDiv = document.getElementById('epic-issues-error-' + index);
      const tbody = document.getElementById('epic-issues-tbody-' + index);
      
      if (row.style.display === 'none') {
        // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
        row.style.display = 'table-row';
        
        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏—Ö
        if (!row.dataset.loaded) {
          loading.style.display = 'block';
          content.style.display = 'none';
          errorDiv.style.display = 'none';
          
          try {
            const response = await fetch(`/api/epics/${epicKey}/issues`);
            const result = await response.json();
            
            loading.style.display = 'none';
            
            if (!result.success) {
              errorDiv.innerHTML = `<p class="muted" style="font-size: 13px; color: #ff5b5b;">–û—à–∏–±–∫–∞: ${escapeHtml(result.error)}</p>`;
              errorDiv.style.display = 'block';
              return;
            }
            
            const issues = result.data || [];
            if (issues.length === 0) {
              errorDiv.innerHTML = '<p class="muted" style="font-size: 13px;">–ù–µ—Ç –∑–∞–¥–∞—á –≤ —ç—Ç–æ–º —ç–ø–∏–∫–µ.</p>';
              errorDiv.style.display = 'block';
              return;
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É –∑–∞–¥–∞—á
            let html = '';
            issues.forEach(issue => {
              html += `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                  <td style="padding: 8px;">
                    <a href="https://topntop.atlassian.net/browse/${escapeHtml(issue.key)}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                      ${escapeHtml(issue.key)}
                    </a>
                    <div style="font-size: 12px; color: var(--muted); margin-top: 2px;">
                      ${escapeHtml(issue.summary || '')}
                    </div>
                  </td>
                  <td style="padding: 8px;">${escapeHtml(issue.assignee || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω')}</td>
                  <td style="text-align: right; padding: 8px;">${issue.original_estimate_hours > 0 ? issue.original_estimate_hours.toFixed(1) + ' —á' : '-'}</td>
                  <td style="text-align: right; padding: 8px;">${issue.time_spent_hours > 0 ? issue.time_spent_hours.toFixed(1) + ' —á' : '-'}</td>
                </tr>
              `;
            });
            
            tbody.innerHTML = html;
            content.style.display = 'block';
            row.dataset.loaded = 'true';
          } catch (e) {
            loading.style.display = 'none';
            errorDiv.innerHTML = `<p class="muted" style="font-size: 13px; color: #ff5b5b;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${escapeHtml(e.message)}</p>`;
            errorDiv.style.display = 'block';
          }
        }
      } else {
        // –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º
        row.style.display = 'none';
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–ª–∏–∑–æ–≤
    async function loadReleases() {
      const loading = document.getElementById('releases-loading');
      const errorDiv = document.getElementById('releases-error');
      const content = document.getElementById('releases-content');
      const tbody = document.getElementById('releases-tbody');
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 –º–∏–Ω—É—Ç—ã
        const response = await fetch(`/api/teams/${teamId}/releases${isCustom ? "?custom=1" : ""}`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        const result = await response.json();
        
        loading.style.display = 'none';
        
        if (!result.success) {
          errorDiv.innerHTML = `<div class="card error"><p><b>–û—à–∏–±–∫–∞:</b> ${result.error}</p></div>`;
          errorDiv.style.display = 'block';
          return;
        }
        
        const releases = result.data || [];
        if (releases.length === 0) {
          errorDiv.innerHTML = '<p class="muted">–ù–µ—Ç —Ä–µ–ª–∏–∑–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>';
          errorDiv.style.display = 'block';
          return;
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã
        function formatDate(dateStr) {
          if (!dateStr) return '';
          const date = new Date(dateStr + 'T00:00:00');
          return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ—Å—Ä–æ—á–µ–Ω –ª–∏ —Ä–µ–ª–∏–∑
        function isOverdue(releaseDateStr) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const releaseDate = new Date(releaseDateStr + 'T00:00:00');
          return releaseDate < today;
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        let html = '';
        releases.forEach((release, idx) => {
          const isOverdueRelease = isOverdue(release.release_date);
          const borderStyle = isOverdueRelease ? 'border-left: 3px solid #ff5b5b;' : '';
          
          html += `
            <tr style="border-bottom: 1px solid var(--border); ${borderStyle}">
              <td style="padding: 10px; word-wrap: break-word; max-width: 0;">
                <a href="https://topntop.atlassian.net/browse/${escapeHtml(release.epic_key)}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                  ${escapeHtml(release.epic_key)}
                </a>
                <div style="font-size: 13px; color: var(--muted); margin-top: 4px; word-wrap: break-word;">
                  ${escapeHtml(release.epic_summary || '')}
                </div>
              </td>
              <td style="padding: 10px;">
                <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                  <div style="position: relative; display: inline-block;">
                    <input 
                      type="date" 
                      id="release-date-${idx}" 
                      value="${release.release_date}" 
                      class="date-picker-input"
                      data-original-date="${release.release_date}"
                      onclick="showSaveButton(${idx})"
                    />
                  </div>
                  <button 
                    id="save-btn-${idx}" 
                    class="save-date-button"
                    style="display: none;"
                    onclick="saveReleaseDate('${escapeHtml(release.epic_key)}', ${idx})"
                  >
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                  </button>
                  <button 
                    id="cancel-btn-${idx}" 
                    class="cancel-date-button"
                    style="display: none;"
                    onclick="cancelDateChange(${idx})"
                  >
                    –û—Ç–º–µ–Ω–∞
                  </button>
                  <span id="release-date-status-${idx}" class="release-date-status"></span>
                </div>
                ${release.version_name ? `<div style="font-size: 12px; color: var(--muted); margin-top: 4px;">${escapeHtml(release.version_name)}</div>` : ''}
                ${isOverdueRelease ? '<div style="font-size: 12px; color: #ff5b5b; margin-top: 2px;">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>' : ''}
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
        content.style.display = 'block';
      } catch (e) {
        loading.style.display = 'none';
        let errorMsg = e.message;
        if (e.name === 'AbortError') {
          errorMsg = '–ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
        }
        errorDiv.innerHTML = `<div class="card error"><p><b>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</b> ${escapeHtml(errorMsg)}</p></div>`;
        errorDiv.style.display = 'block';
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç—ã —Ä–µ–ª–∏–∑–∞
    async function updateReleaseDate(epicKey, newDate, index) {
      const statusEl = document.getElementById('release-date-status-' + index);
      statusEl.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      statusEl.style.color = 'var(--muted)';
      
      try {
        const response = await fetch(`/api/epics/${epicKey}/release-date`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ release_date: newDate })
        });
        
        const result = await response.json();
        
        if (result.success) {
          statusEl.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
          statusEl.style.color = '#5bff8c';
          setTimeout(() => {
            statusEl.textContent = '';
          }, 2000);
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–ª–∏–∑–æ–≤, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö
          loadReleases();
        } else {
          statusEl.textContent = '‚úó –û—à–∏–±–∫–∞';
          statusEl.style.color = '#ff5b5b';
          alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç—ã: ' + result.error);
        }
      } catch (e) {
        statusEl.textContent = '‚úó –û—à–∏–±–∫–∞';
        statusEl.style.color = '#ff5b5b';
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç—ã: ' + e.message);
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–æ–∫ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –∏ "–û—Ç–º–µ–Ω–∞"
    function showSaveButton(index) {
      const saveBtn = document.getElementById('save-btn-' + index);
      const cancelBtn = document.getElementById('cancel-btn-' + index);
      const dateInput = document.getElementById('release-date-' + index);
      const originalDate = dateInput.getAttribute('data-original-date');
      const currentDate = dateInput.value;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞—Ç–∞ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
      if (currentDate !== originalDate) {
        saveBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
      } else {
        saveBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç—ã
    function cancelDateChange(index) {
      const dateInput = document.getElementById('release-date-' + index);
      const saveBtn = document.getElementById('save-btn-' + index);
      const cancelBtn = document.getElementById('cancel-btn-' + index);
      const statusEl = document.getElementById('release-date-status-' + index);
      const originalDate = dateInput.getAttribute('data-original-date');
      
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –¥–∞—Ç—É
      dateInput.value = originalDate;
      
      // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
      saveBtn.style.display = 'none';
      cancelBtn.style.display = 'none';
      
      // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å
      statusEl.textContent = '';
      statusEl.style.background = '';
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞—Ç—ã —Ä–µ–ª–∏–∑–∞
    async function saveReleaseDate(epicKey, index) {
      const dateInput = document.getElementById('release-date-' + index);
      const saveBtn = document.getElementById('save-btn-' + index);
      const statusEl = document.getElementById('release-date-status-' + index);
      const newDate = dateInput.value;
      
      if (!newDate) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É');
        return;
      }
      
      // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
      saveBtn.disabled = true;
      saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
      statusEl.textContent = '';
      
      try {
        const response = await fetch(`/api/epics/${epicKey}/release-date`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ release_date: newDate })
        });
        
        const result = await response.json();
        
        if (result.success) {
          // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –¥–∞—Ç—É
          dateInput.setAttribute('data-original-date', newDate);
          
          // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
          const cancelBtn = document.getElementById('cancel-btn-' + index);
          saveBtn.style.display = 'none';
          cancelBtn.style.display = 'none';
          saveBtn.disabled = false;
          saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —É—Å–ø–µ—Ö–∞
          statusEl.textContent = '‚úì –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ';
          statusEl.style.color = '#5bff8c';
          statusEl.style.background = 'rgba(91, 255, 140, 0.15)';
          setTimeout(() => {
            statusEl.textContent = '';
            statusEl.style.background = '';
          }, 2000);
          
          // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–µ–ª–∏–∑–æ–≤, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö
          setTimeout(() => {
            loadReleases();
          }, 500);
        } else {
          saveBtn.disabled = false;
          saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
          statusEl.textContent = '‚úó –û—à–∏–±–∫–∞';
          statusEl.style.color = '#ff5b5b';
          statusEl.style.background = 'rgba(255, 91, 91, 0.15)';
          alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç—ã: ' + result.error);
        }
      } catch (e) {
        saveBtn.disabled = false;
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        statusEl.textContent = '‚úó –û—à–∏–±–∫–∞';
        statusEl.style.color = '#ff5b5b';
        statusEl.style.background = 'rgba(255, 91, 91, 0.15)';
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç—ã: ' + e.message);
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–∞—Ç—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('date-picker-input')) {
        const index = e.target.id.replace('release-date-', '');
        showSaveButton(index);
      }
    });
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –¥–ª—è —Ç–∞–±–∞ –§–∏–ª—å—Ç—Ä—ã
    async function loadFilterUsers() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 —Å–µ–∫—É–Ω–¥
        const response = await fetch(`/api/teams/${teamId}/users${isCustom ? "?custom=1" : ""}`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        
        if (result.success && result.data) {
          const select = document.getElementById('filter-user-select');
          if (select) {
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>';
            
            result.data.forEach(user => {
              const option = document.createElement('option');
              option.value = user.jira_account_id || '';
              option.textContent = user.display_name || user.name || '–ë–µ–∑ –∏–º–µ–Ω–∏';
              select.appendChild(option);
            });
          }
        } else {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤:', e);
        if (e.name === 'AbortError') {
          console.error('–ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è');
        }
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∏–ø–∞ —Ñ–∏–ª—å—Ç—Ä–∞
    function onFilterTypeChange() {
      const filterType = document.getElementById('filter-type-select').value;
      const userContainer = document.getElementById('filter-user-container');
      const periodContainer = document.getElementById('filter-period-container');
      const loading = document.getElementById('filter-loading');
      const content = document.getElementById('filter-content');
      const errorDiv = document.getElementById('filter-error');
      
      // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–µ–ª–µ–∫—Ç—ã –∏ –∫–æ–Ω—Ç–µ–Ω—Ç
      userContainer.style.display = 'none';
      periodContainer.style.display = 'none';
      content.style.display = 'none';
      errorDiv.style.display = 'none';
      
      if (!filterType) {
        loading.style.display = 'block';
        loading.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á';
        return;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –¥–ª—è –æ–±–æ–∏—Ö —Ç–∏–ø–æ–≤ —Ñ–∏–ª—å—Ç—Ä–æ–≤
      userContainer.style.display = 'block';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç –ø–µ—Ä–∏–æ–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è "–ó–∞–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏"
      if (filterType === 'done') {
        periodContainer.style.display = 'block';
      }
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤, –µ—Å–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
      const userSelect = document.getElementById('filter-user-select');
      if (userSelect.options.length <= 1) {
        loadFilterUsers();
      }
      
      loading.style.display = 'block';
      loading.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞' + (filterType === 'done' ? ' –∏ –ø–µ—Ä–∏–æ–¥' : '') + ' –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á –ø–æ —Ñ–∏–ª—å—Ç—Ä—É
    async function loadFilterTasks() {
      const filterType = document.getElementById('filter-type-select').value;
      const userSelect = document.getElementById('filter-user-select');
      const periodSelect = document.getElementById('filter-period-select');
      const loading = document.getElementById('filter-loading');
      const errorDiv = document.getElementById('filter-error');
      const content = document.getElementById('filter-content');
      const tbody = document.getElementById('filter-tbody');
      const extraTh = document.getElementById('filter-th-extra');
      
      if (!filterType) {
        loading.style.display = 'block';
        loading.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á';
        errorDiv.style.display = 'none';
        content.style.display = 'none';
        return;
      }
      
      const userId = userSelect ? userSelect.value : '';
      
      // –î–ª—è "–ó–∞–∫—Ä—ã—Ç—ã–µ –∑–∞–¥–∞—á–∏" —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, –∏ –ø–µ—Ä–∏–æ–¥
      if (filterType === 'done') {
        if (!userId) {
          loading.style.display = 'block';
          loading.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –∏ –ø–µ—Ä–∏–æ–¥ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á';
          errorDiv.style.display = 'none';
          content.style.display = 'none';
          return;
        }
      } else if (filterType === 'no-release') {
        // –î–ª—è "–ó–∞–¥–∞—á–∏ –±–µ–∑ —Ä–µ–ª–∏–∑–∞" —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –æ–ø—Ü–∏–æ–Ω–∞–ª–µ–Ω
      }
      
      loading.style.display = 'block';
      loading.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á...';
      errorDiv.style.display = 'none';
      content.style.display = 'none';
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 –º–∏–Ω—É—Ç—ã
        
        let url;
        if (filterType === 'done') {
          const period = periodSelect ? periodSelect.value : 'today';
          url = `/api/teams/${teamId}/done?user_id=${encodeURIComponent(userId)}&period=${period}${isCustom ? "&custom=1" : ""}`;
        } else {
          url = userId 
            ? `/api/teams/${teamId}/no-release?user_id=${encodeURIComponent(userId)}${isCustom ? "&custom=1" : ""}`
            : `/api/teams/${teamId}/no-release${isCustom ? "?custom=1" : ""}`;
        }
        
        const response = await fetch(url, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        const result = await response.json();
        
        loading.style.display = 'none';
        
        if (!result.success) {
          errorDiv.innerHTML = `<div class="card error"><p><b>–û—à–∏–±–∫–∞:</b> ${result.error}</p></div>`;
          errorDiv.style.display = 'block';
          return;
        }
        
        const tasks = result.data || [];
        if (tasks.length === 0) {
          const emptyMsg = filterType === 'done' 
            ? '–ù–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥.'
            : '–ù–µ—Ç –∑–∞–¥–∞—á –±–µ–∑ —Ä–µ–ª–∏–∑–∞.';
          errorDiv.innerHTML = `<p class="muted">${emptyMsg}</p>`;
          errorDiv.style.display = 'block';
          return;
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
        function formatDate(dateStr) {
          if (!dateStr) return '-';
          const date = new Date(dateStr);
          return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ñ–∏–ª—å—Ç—Ä–∞
        const dateTh = document.querySelector('#filter-content thead tr th:last-child');
        if (filterType === 'done') {
          extraTh.textContent = '';
          extraTh.style.display = 'none';
          if (dateTh) dateTh.textContent = '–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è';
        } else {
          extraTh.textContent = '–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å';
          extraTh.style.display = '';
          if (dateTh) dateTh.textContent = '–°–æ–∑–¥–∞–Ω–æ';
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        let html = '';
        tasks.forEach(task => {
          if (filterType === 'done') {
            html += `
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 10px;">
                  <a href="https://topntop.atlassian.net/browse/${escapeHtml(task.key)}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                    ${escapeHtml(task.key)}
                  </a>
                </td>
                <td style="padding: 10px;">
                  ${escapeHtml(task.summary || '')}
                </td>
                <td style="padding: 10px;">
                  ${task.resolved_date ? formatDate(task.resolved_date) : '-'}
                </td>
              </tr>
            `;
          } else {
            html += `
              <tr style="border-bottom: 1px solid var(--border);">
                <td style="padding: 10px;">
                  <a href="https://topntop.atlassian.net/browse/${escapeHtml(task.key)}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;">
                    ${escapeHtml(task.key)}
                  </a>
                </td>
                <td style="padding: 10px;">
                  ${escapeHtml(task.summary || '')}
                </td>
                <td style="padding: 10px;">
                  ${escapeHtml(task.assignee || '-')}
                </td>
                <td style="padding: 10px;">
                  ${formatDate(task.created)}
                </td>
              </tr>
            `;
          }
        });
        
        tbody.innerHTML = html;
        content.style.display = 'block';
      } catch (e) {
        loading.style.display = 'none';
        let errorMsg = e.message;
        if (e.name === 'AbortError') {
          errorMsg = '–ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
        }
        errorDiv.innerHTML = `<div class="card error"><p><b>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</b> ${escapeHtml(errorMsg)}</p></div>`;
        errorDiv.style.display = 'block';
      }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á Improve
    async function loadImprove() {
      const loading = document.getElementById('improve-loading');
      const errorDiv = document.getElementById('improve-error');
      const content = document.getElementById('improve-content');
      const tbody = document.getElementById('improve-tbody');
      
      loading.style.display = 'block';
      errorDiv.style.display = 'none';
      content.style.display = 'none';
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 –º–∏–Ω—É—Ç—ã
        const response = await fetch(`/api/teams/${teamId}/improve${isCustom ? "?custom=1" : ""}`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        const result = await response.json();
        
        loading.style.display = 'none';
        
        if (!result.success) {
          errorDiv.innerHTML = `<div class="card error"><p><b>–û—à–∏–±–∫–∞:</b> ${result.error}</p></div>`;
          errorDiv.style.display = 'block';
          return;
        }
        
        const tasks = result.data || [];
        if (tasks.length === 0) {
          errorDiv.innerHTML = '<p class="muted">–ù–µ—Ç –∑–∞–¥–∞—á –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>';
          errorDiv.style.display = 'block';
          return;
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
        function formatDate(dateStr) {
          if (!dateStr) return '-';
          const date = new Date(dateStr);
          return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
        let html = '';
        tasks.forEach((task, index) => {
          html += `
            <tr data-task-key="${escapeHtml(task.key)}" draggable="true" style="border-bottom: 1px solid var(--border); cursor: move;" 
                ondragstart="handleImproveDragStart(event)" 
                ondragover="handleImproveDragOver(event)" 
                ondragenter="handleImproveDragEnter(event)" 
                ondragleave="handleImproveDragLeave(event)" 
                ondrop="handleImproveDrop(event)" 
                ondragend="handleImproveDragEnd(event)">
              <td style="padding: 10px;">
                <a href="https://topntop.atlassian.net/browse/${escapeHtml(task.key)}" target="_blank" style="color: var(--primary); text-decoration: none; font-weight: 600;" onclick="event.stopPropagation();">
                  ${escapeHtml(task.key)}
                </a>
              </td>
              <td style="padding: 10px;">
                ${escapeHtml(task.summary || '')}
              </td>
              <td style="padding: 10px; color: var(--muted); font-size: 13px;">
                ${formatDate(task.created)}
              </td>
            </tr>
          `;
        });
        
        tbody.innerHTML = html;
        content.style.display = 'block';
      } catch (e) {
        loading.style.display = 'none';
        let errorMsg = e.message;
        if (e.name === 'AbortError') {
          errorMsg = '–ó–∞–ø—Ä–æ—Å –ø—Ä–µ–≤—ã—Å–∏–ª –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
        }
        errorDiv.innerHTML = `<div class="card error"><p><b>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</b> ${escapeHtml(errorMsg)}</p></div>`;
        errorDiv.style.display = 'block';
      }
    }
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è drag-and-drop –≤ —Ç–∞–±–ª–∏—Ü–µ Improve
    let draggedImproveRow = null;
    let improveDragOverRow = null;
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ drag-and-drop –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã Improve
    function handleImproveDragStart(e) {
      draggedImproveRow = e.target.closest('tr');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', draggedImproveRow.outerHTML);
      draggedImproveRow.style.opacity = '0.5';
    }
    
    function handleImproveDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      return false;
    }
    
    function handleImproveDragEnter(e) {
      const row = e.target.closest('tr');
      if (row && row !== draggedImproveRow && row.hasAttribute('data-task-key')) {
        improveDragOverRow = row;
        row.style.backgroundColor = 'rgba(0, 123, 255, 0.2)';
      }
    }
    
    function handleImproveDragLeave(e) {
      const row = e.target.closest('tr');
      if (row && row === improveDragOverRow) {
        row.style.backgroundColor = '';
        improveDragOverRow = null;
      }
    }
    
    function handleImproveDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      
      const dropRow = e.target.closest('tr');
      if (!dropRow || !draggedImproveRow || dropRow === draggedImproveRow || !dropRow.hasAttribute('data-task-key')) {
        return false;
      }
      
      const tbody = dropRow.parentNode;
      const allRows = Array.from(tbody.querySelectorAll('tr[data-task-key]'));
      const draggedIndex = allRows.indexOf(draggedImproveRow);
      const dropIndex = allRows.indexOf(dropRow);
      
      if (draggedIndex < dropIndex) {
        tbody.insertBefore(draggedImproveRow, dropRow.nextSibling);
      } else {
        tbody.insertBefore(draggedImproveRow, dropRow);
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫
      saveImproveOrder();
      
      return false;
    }
    
    function handleImproveDragEnd(e) {
      // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å—Ç–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
      const tbody = document.getElementById('improve-tbody');
      if (tbody) {
        const allRows = tbody.querySelectorAll('tr[data-task-key]');
        allRows.forEach(row => {
          row.style.opacity = '';
          row.style.backgroundColor = '';
        });
      }
      
      if (draggedImproveRow) {
        draggedImproveRow.style.opacity = '';
      }
      if (improveDragOverRow) {
        improveDragOverRow.style.backgroundColor = '';
        improveDragOverRow = null;
      }
      draggedImproveRow = null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –∑–∞–¥–∞—á Improve
    async function saveImproveOrder() {
      const tbody = document.getElementById('improve-tbody');
      if (!tbody) return;
      
      const rows = Array.from(tbody.querySelectorAll('tr[data-task-key]'));
      const taskKeys = rows.map(row => row.getAttribute('data-task-key'));
      
      if (taskKeys.length === 0) return;
      
      try {
        const response = await fetch(`/api/teams/${teamId}/improve/order${isCustom ? "?custom=1" : ""}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ task_keys: taskKeys })
        });
        
        const result = await response.json();
        if (!result.success) {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞:', result.error);
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ—Ä—è–¥–∫–∞:', e);
      }
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadWorklog();
    
    // ========== –î–ò–ê–ì–†–ê–ú–ú–ê –ì–ê–ù–¢–ê ==========
    
    let ganttData = null;
    let ganttState = null;
    let ganttConnections = [];
    let ganttDraggedTask = null;
    let ganttConnectionMode = null;
    let ganttDayWidth = 20;
    let ganttRowHeight = 40;
    let ganttStartDate = null;
    let ganttEndDate = null;
    let ganttCalendarDays = [];
    let ganttAutoMode = false;
    let ganttExpandedEpics = {}; // –•—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ—Å—Ç–∏ —ç–ø–∏–∫–æ–≤
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞—Ç (5 –º–µ—Å—è—Ü–µ–≤ —Å —è–Ω–≤–∞—Ä—è —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞)
    function initGanttDates() {
      const now = new Date();
      ganttStartDate = new Date(now.getFullYear(), 0, 1); // 1 —è–Ω–≤–∞—Ä—è
      ganttEndDate = new Date(now.getFullYear(), 4, 31); // 31 –º–∞—è (5 –º–µ—Å—è—Ü–µ–≤)
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –¥–Ω–µ–π
      ganttCalendarDays = [];
      const current = new Date(ganttStartDate);
      while (current <= ganttEndDate) {
        const dayOfWeek = current.getDay();
        ganttCalendarDays.push({
          date: new Date(current),
          isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
        });
        current.setDate(current.getDate() + 1);
      }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –∏ —Å–∫—Ä–æ–ª–ª–∞ –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ —Å–≤—è–∑–µ–π
    let ganttResizeTimeout = null;
    window.addEventListener('resize', () => {
      if (ganttResizeTimeout) {
        clearTimeout(ganttResizeTimeout);
      }
      ganttResizeTimeout = setTimeout(() => {
        if (window.ganttLoaded) {
          renderGanttConnections();
        }
      }, 250);
    });
    
    const ganttContent = document.getElementById('gantt-content');
    if (ganttContent) {
      let ganttScrollTimeout = null;
      ganttContent.addEventListener('scroll', () => {
        if (ganttScrollTimeout) {
          clearTimeout(ganttScrollTimeout);
        }
        ganttScrollTimeout = setTimeout(() => {
          if (window.ganttLoaded) {
            renderGanttConnections();
          }
        }, 100);
      });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ì–∞–Ω—Ç–∞
    async function loadGantt() {
      const loading = document.getElementById('gantt-loading');
      const error = document.getElementById('gantt-error');
      const content = document.getElementById('gantt-content');
      
      loading.style.display = 'block';
      error.style.display = 'none';
      content.style.display = 'none';
      
      try {
        const response = await fetch(`/api/teams/${teamId}/gantt${isCustom ? "?custom=1" : ""}`);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º JSON
        if (!response.ok) {
          const errorText = await response.text();
          let errorMessage = `HTTP ${response.status}: ${errorText}`;
          try {
            const errorJson = JSON.parse(errorText);
            errorMessage = errorJson.error || errorJson.detail || errorMessage;
          } catch (e) {
            // –ï—Å–ª–∏ –Ω–µ JSON, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ—Å—Ç—å
          }
          throw new Error(errorMessage);
        }
        
        const result = await response.json();
        
        if (!result.success) {
          throw new Error(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
        }
        
        ganttData = result.data;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (await, —á—Ç–æ–±—ã –¥–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∫–∏)
        await loadGanttState();
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —ç–ø–∏–∫–∏ —Å –∑–∞–¥–∞—á–∞–º–∏
        if (ganttState && ganttState.tasks && Object.keys(ganttState.tasks).length > 0) {
          ganttData.forEach(epic => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É —ç—Ç–æ–≥–æ —ç–ø–∏–∫–∞ –∑–∞–¥–∞—á–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏
            const hasSavedTasks = epic.tasks.some(task => ganttState.tasks[task.id]);
            if (hasSavedTasks) {
              ganttExpandedEpics[epic.id] = true;
            }
          });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞—Ç—ã
        initGanttDates();
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –¥–∏–∞–≥—Ä–∞–º–º—É
        renderGantt();
        
        loading.style.display = 'none';
        content.style.display = 'block';
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        document.getElementById('gantt-auto-distribute').style.display = 'inline-block';
        if (ganttAutoMode) {
          document.getElementById('gantt-remove-auto').style.display = 'inline-block';
        }
      } catch (e) {
        console.error('Gantt load error:', e);
        loading.style.display = 'none';
        error.style.display = 'block';
        error.innerHTML = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}`;
      }
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞–ª–µ–Ω–¥–∞—Ä–Ω–æ–π —Å–µ—Ç–∫–∏
    function renderGanttCalendar() {
      const calendarEl = document.getElementById('gantt-calendar');
      if (!calendarEl) return;
      
      const months = [];
      let currentMonth = null;
      
      ganttCalendarDays.forEach((day, index) => {
        const month = day.date.getMonth();
        const monthName = day.date.toLocaleString('ru-RU', { month: 'long' });
        
        if (!currentMonth || currentMonth.month !== month) {
          if (currentMonth) {
            months.push(currentMonth);
          }
          currentMonth = {
            month,
            name: monthName,
            days: [],
            startIndex: index,
          };
        }
        
        currentMonth.days.push(day);
      });
      
      if (currentMonth) {
        months.push(currentMonth);
      }
      
      // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â—É—é —à–∏—Ä–∏–Ω—É –∫–∞–ª–µ–Ω–¥–∞—Ä—è
      let totalCalendarWidth = 420; // –®–∏—Ä–∏–Ω–∞ —Å—Ç–æ–ª–±—Ü–∞ "–ó–∞–¥–∞—á–∞"
      months.forEach(month => {
        totalCalendarWidth += month.days.length * ganttDayWidth;
      });
      
      let html = '<div style="display: flex; border-bottom: 1px solid var(--border); min-width: ' + totalCalendarWidth + 'px;">';
      html += '<div style="width: 420px; min-width: 420px; flex-shrink: 0; padding: 8px; font-weight: 600; border-right: 1px solid var(--border);">–ó–∞–¥–∞—á–∞</div>';
      
      months.forEach(month => {
        const monthWidth = month.days.length * ganttDayWidth;
        html += `<div style="width: ${monthWidth}px; border-right: 1px solid var(--border);">`;
        html += `<div style="padding: 8px; font-weight: 600; text-align: center; border-bottom: 1px solid var(--border);">${month.name}</div>`;
        html += '<div style="display: flex;">';
        
        month.days.forEach(day => {
          const bgColor = day.isWeekend ? 'var(--border)' : 'transparent';
          const dayNum = day.date.getDate();
          html += `<div style="width: ${ganttDayWidth}px; padding: 4px; text-align: center; font-size: 11px; background: ${bgColor}; border-right: 1px solid var(--border);">${dayNum}</div>`;
        });
        
        html += '</div></div>';
      });
      
      html += '</div>';
      calendarEl.innerHTML = html;
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∑–∞–¥–∞—á
      const tasksEl = document.getElementById('gantt-tasks');
      if (tasksEl) {
        tasksEl.style.minWidth = totalCalendarWidth + 'px';
      }
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —à–∏—Ä–∏–Ω—É –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
      window.ganttTotalWidth = totalCalendarWidth;
    }
    
    // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –º–µ–∂–¥—É –¥–∞—Ç–∞–º–∏
    function getWorkingDays(startDate, endDate) {
      let count = 0;
      const current = new Date(startDate);
      while (current <= endDate) {
        const dayOfWeek = current.getDay();
        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
          count++;
        }
        current.setDate(current.getDate() + 1);
      }
      return count;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –¥–ª—è –∑–∞–¥–∞—á–∏ (–≤ —Ä–∞–±–æ—á–∏—Ö –¥–Ω—è—Ö –æ—Ç –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–∏–æ–¥–∞)
    function getTaskStartDate(task) {
      if (ganttState && ganttState.tasks && ganttState.tasks[task.id]) {
        return ganttState.tasks[task.id].startDate;
      }
      return null;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–ª—è –∑–∞–¥–∞—á–∏
    function getTaskEndDate(task) {
      const startDate = getTaskStartDate(task);
      if (startDate === null) return null;
      
      const workingDays = Math.ceil(task.originalEstimate / 8);
      let current = new Date(ganttCalendarDays[startDate].date);
      let daysAdded = 0;
      
      while (daysAdded < workingDays) {
        const dayOfWeek = current.getDay();
        if (dayOfWeek !== 0 && dayOfWeek !== 6) {
          daysAdded++;
        }
        if (daysAdded < workingDays) {
          current.setDate(current.getDate() + 1);
        }
      }
      
      // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —ç—Ç–æ–π –¥–∞—Ç—ã –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
      for (let i = 0; i < ganttCalendarDays.length; i++) {
        if (ganttCalendarDays[i].date.toDateString() === current.toDateString()) {
          return i;
        }
      }
      
      return startDate;
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —ç–ø–∏–∫–æ–≤ –∏ –∑–∞–¥–∞—á
    function renderGanttTasks() {
      const tasksEl = document.getElementById('gantt-tasks');
      if (!tasksEl || !ganttData) return;
      
      // –ü–æ–ª—É—á–∞–µ–º –æ–±—â—É—é —à–∏—Ä–∏–Ω—É –∫–∞–ª–µ–Ω–¥–∞—Ä—è
      const totalWidth = window.ganttTotalWidth || (420 + ganttCalendarDays.length * ganttDayWidth);
      
      let html = '<div style="padding-top: 10px;">';
      let rowIndex = 0;
      
      ganttData.forEach(epic => {
        // –°—Ç—Ä–æ–∫–∞ —ç–ø–∏–∫–∞
        const epicStart = getEpicStartDate(epic);
        const epicEnd = getEpicEndDate(epic);
        const isExpanded = ganttExpandedEpics[epic.id] || false;
        const expandIcon = isExpanded ? '‚ñº' : '‚ñ∂';
        
        html += `<div class="gantt-row" data-epic-id="${epic.id}" style="display: flex; height: ${ganttRowHeight}px; border-bottom: 1px solid var(--border); min-width: ${totalWidth}px; margin-bottom: 10px;">`;
        html += `<div class="gantt-label gantt-epic-header" data-epic-id="${epic.id}" style="width: 420px; padding: 8px; border-right: 1px solid var(--border); font-weight: 600; background: var(--card); cursor: pointer; user-select: none; display: flex; align-items: center; gap: 6px; font-size: 12px;">`;
        html += `<span class="gantt-expand-icon" style="font-size: 10px; color: var(--muted);">${expandIcon}</span>`;
        html += `<span style="font-size: 12px;">${epic.key}: ${epic.summary}</span>`;
        html += `</div>`;
        html += `<div class="gantt-bar-container" style="position: relative; flex: 1; height: 100%;">`;
        
        if (epicStart !== null && epicEnd !== null) {
          const left = epicStart * ganttDayWidth;
          const width = (epicEnd - epicStart + 1) * ganttDayWidth;
          html += `<div class="gantt-bar epic-bar" style="position: absolute; left: ${left}px; top: 8px; width: ${width}px; height: 24px; background: var(--primary); opacity: 0.3; border-radius: 4px;"></div>`;
        }
        
        html += `</div></div>`;
        rowIndex++;
        
        // –ó–∞–¥–∞—á–∏ —ç–ø–∏–∫–∞ (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        epic.tasks.forEach(task => {
          const taskDisplay = isExpanded ? 'flex' : 'none';
          const taskStart = getTaskStartDate(task);
          const taskEnd = getTaskEndDate(task);
          
          html += `<div class="gantt-row gantt-task-row" data-task-id="${task.id}" data-epic-id="${epic.id}" style="display: ${taskDisplay}; height: ${ganttRowHeight}px; border-bottom: 1px solid var(--border); min-width: ${totalWidth}px;">`;
          html += `<div class="gantt-label" style="width: 420px; padding: 8px; border-right: 1px solid var(--border); background: var(--card); font-size: 12px;">`;
          html += `${task.key}: ${task.summary}`;
          html += `</div>`;
          html += `<div class="gantt-bar-container" style="position: relative; flex: 1; height: 100%;">`;
          
          if (taskStart !== null && taskEnd !== null) {
            const left = taskStart * ganttDayWidth;
            const width = (taskEnd - taskStart + 1) * ganttDayWidth;
            html += `<div class="gantt-bar task-bar" draggable="true" data-task-id="${task.id}" style="position: absolute; left: ${left}px; top: 8px; width: ${width}px; height: 24px; background: var(--primary); border-radius: 4px; cursor: move; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;">`;
            html += `${task.originalEstimate}—á`;
            html += `<div class="connection-point left" style="position: absolute; left: -4px; top: 50%; transform: translateY(-50%); width: 8px; height: 8px; background: var(--primary); border-radius: 50%; cursor: crosshair; z-index: 10;"></div>`;
            html += `<div class="connection-point right" style="position: absolute; right: -4px; top: 50%; transform: translateY(-50%); width: 8px; height: 8px; background: var(--primary); border-radius: 50%; cursor: crosshair; z-index: 10;"></div>`;
            html += `<div class="connection-point top" style="position: absolute; top: -4px; left: 50%; transform: translateX(-50%); width: 8px; height: 8px; background: var(--primary); border-radius: 50%; cursor: crosshair; z-index: 10;"></div>`;
            html += `<div class="connection-point bottom" style="position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%); width: 8px; height: 8px; background: var(--primary); border-radius: 50%; cursor: crosshair; z-index: 10;"></div>`;
            html += `</div>`;
          }
          
          html += `</div></div>`;
          rowIndex++;
        });
      });
      
      html += '</div>';
      tasksEl.innerHTML = html;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è drag & drop
      setupGanttDragDrop();
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–≤—è–∑–µ–π
      setupGanttConnections();
      
      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —ç–ø–∏–∫–æ–≤
      setupGanttEpicToggle();
      
      // –†–µ–Ω–¥–µ—Ä–∏–º —Å–≤—è–∑–∏ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏, —á—Ç–æ–±—ã DOM –æ–±–Ω–æ–≤–∏–ª—Å—è
      setTimeout(() => {
        renderGanttConnections();
      }, 100);
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —ç–ø–∏–∫–æ–≤
    function setupGanttEpicToggle() {
      const epicHeaders = document.querySelectorAll('.gantt-epic-header');
      epicHeaders.forEach(header => {
        header.addEventListener('click', function(e) {
          e.stopPropagation();
          const epicId = this.getAttribute('data-epic-id');
          toggleEpic(epicId);
        });
      });
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —ç–ø–∏–∫–∞ (—Å–≤–µ—Ä–Ω—É—Ç—å/—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)
    function toggleEpic(epicId) {
      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      ganttExpandedEpics[epicId] = !ganttExpandedEpics[epicId];
      
      // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∑–∞–¥–∞—á–∏ —ç—Ç–æ–≥–æ —ç–ø–∏–∫–∞
      const taskRows = document.querySelectorAll(`.gantt-task-row[data-epic-id="${epicId}"]`);
      const isExpanded = ganttExpandedEpics[epicId];
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–¥–∞—á–∏
      taskRows.forEach(row => {
        row.style.display = isExpanded ? 'flex' : 'none';
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É
      const epicHeader = document.querySelector(`.gantt-epic-header[data-epic-id="${epicId}"]`);
      if (epicHeader) {
        const icon = epicHeader.querySelector('.gantt-expand-icon');
        if (icon) {
          icon.textContent = isExpanded ? '‚ñº' : '‚ñ∂';
        }
      }
      
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–≤—è–∑–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏
      setTimeout(() => {
        renderGanttConnections();
      }, 50);
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ —ç–ø–∏–∫–∞
    function getEpicStartDate(epic) {
      if (!epic.tasks || epic.tasks.length === 0) return null;
      
      let minStart = null;
      epic.tasks.forEach(task => {
        const start = getTaskStartDate(task);
        if (start !== null && (minStart === null || start < minStart)) {
          minStart = start;
        }
      });
      
      return minStart;
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è —ç–ø–∏–∫–∞
    function getEpicEndDate(epic) {
      if (!epic.tasks || epic.tasks.length === 0) return null;
      
      let maxEnd = null;
      epic.tasks.forEach(task => {
        const end = getTaskEndDate(task);
        if (end !== null && (maxEnd === null || end > maxEnd)) {
          maxEnd = end;
        }
      });
      
      return maxEnd;
    }
    
    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    function renderGantt() {
      renderGanttCalendar();
      renderGanttTasks();
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ drag & drop
    function setupGanttDragDrop() {
      const taskBars = document.querySelectorAll('.task-bar');
      taskBars.forEach(bar => {
        bar.addEventListener('dragstart', handleGanttDragStart);
        bar.addEventListener('drag', handleGanttDrag);
        bar.addEventListener('dragend', handleGanttDragEnd);
      });
      
      const containers = document.querySelectorAll('.gantt-bar-container');
      containers.forEach(container => {
        container.addEventListener('dragover', handleGanttDragOver);
        container.addEventListener('drop', handleGanttDrop);
      });
    }
    
    function handleGanttDragStart(e) {
      ganttDraggedTask = e.target;
      e.target.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleGanttDrag(e) {
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
    }
    
    function handleGanttDragEnd(e) {
      if (ganttDraggedTask) {
        ganttDraggedTask.style.opacity = '1';
        ganttDraggedTask = null;
      }
    }
    
    function handleGanttDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }
    
    function handleGanttDrop(e) {
      e.preventDefault();
      
      if (!ganttDraggedTask) return;
      
      const container = e.currentTarget;
      const rect = container.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const dayIndex = Math.floor(x / ganttDayWidth);
      
      if (dayIndex < 0 || dayIndex >= ganttCalendarDays.length) return;
      
      const taskId = ganttDraggedTask.getAttribute('data-task-id');
      if (!ganttState.tasks) {
        ganttState.tasks = {};
      }
      
      if (!ganttState.tasks[taskId]) {
        ganttState.tasks[taskId] = {};
      }
      
      ganttState.tasks[taskId].startDate = dayIndex;
      
      // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
      moveConnectedTasks(taskId, dayIndex);
      
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
      renderGantt();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
      document.getElementById('gantt-save').style.display = 'inline-block';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
      setTimeout(() => {
        renderGanttConnections();
      }, 100);
    }
    
    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á
    function moveConnectedTasks(taskId, newStartDate) {
      if (!ganttState.connections) return;
      
      const oldStartDate = ganttState.tasks[taskId]?.startDate;
      if (oldStartDate === null || oldStartDate === undefined) return;
      
      const offset = newStartDate - oldStartDate;
      
      ganttState.connections.forEach(conn => {
        let otherTaskId = null;
        if (conn.from === taskId) {
          otherTaskId = conn.to;
        } else if (conn.to === taskId) {
          otherTaskId = conn.from;
        }
        
        if (otherTaskId && ganttState.tasks[otherTaskId]) {
          const currentStart = ganttState.tasks[otherTaskId].startDate;
          if (currentStart !== null && currentStart !== undefined) {
            ganttState.tasks[otherTaskId].startDate = currentStart + offset;
          }
        }
      });
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏
    function setupGanttConnections() {
      const connectionPoints = document.querySelectorAll('.connection-point');
      connectionPoints.forEach(point => {
        point.addEventListener('click', handleConnectionPointClick);
      });
    }
    
    function handleConnectionPointClick(e) {
      e.stopPropagation();
      
      if (!ganttConnectionMode) {
        // –ù–∞—á–∏–Ω–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–∏
        const taskBar = e.target.closest('.task-bar');
        const taskId = taskBar.getAttribute('data-task-id');
        const pointType = e.target.classList.contains('left') ? 'left' :
                         e.target.classList.contains('right') ? 'right' :
                         e.target.classList.contains('top') ? 'top' : 'bottom';
        
        ganttConnectionMode = {
          fromTask: taskId,
          fromPoint: pointType,
        };
        
        e.target.style.background = 'var(--success)';
      } else {
        // –ó–∞–≤–µ—Ä—à–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–∏
        const taskBar = e.target.closest('.task-bar');
        const toTaskId = taskBar.getAttribute('data-task-id');
        const toPointType = e.target.classList.contains('left') ? 'left' :
                           e.target.classList.contains('right') ? 'right' :
                           e.target.classList.contains('top') ? 'top' : 'bottom';
        
        if (ganttConnectionMode.fromTask !== toTaskId) {
          if (!ganttState.connections) {
            ganttState.connections = [];
          }
          
          ganttState.connections.push({
            from: ganttConnectionMode.fromTask,
            fromPoint: ganttConnectionMode.fromPoint,
            to: toTaskId,
            toPoint: toPointType,
          });
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
          document.querySelectorAll('.connection-point').forEach(p => {
            p.style.background = 'var(--primary)';
          });
          
          renderGantt();
          document.getElementById('gantt-save').style.display = 'inline-block';
        }
        
        ganttConnectionMode = null;
      }
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–≤—è–∑–µ–π
    function renderGanttConnections() {
      const svg = document.getElementById('gantt-connections');
      if (!svg || !ganttState || !ganttState.connections) return;
      
      svg.innerHTML = '';
      
      // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –¥–ª—è —Å—Ç—Ä–µ–ª–æ–∫ –æ–¥–∏–Ω —Ä–∞–∑
      const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
      const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
      marker.setAttribute('id', 'arrowhead');
      marker.setAttribute('markerWidth', '10');
      marker.setAttribute('markerHeight', '10');
      marker.setAttribute('refX', '9');
      marker.setAttribute('refY', '3');
      marker.setAttribute('orient', 'auto');
      const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
      polygon.setAttribute('points', '0 0, 10 3, 0 6');
      polygon.setAttribute('fill', 'var(--primary)');
      marker.appendChild(polygon);
      defs.appendChild(marker);
      svg.appendChild(defs);
      
      ganttState.connections.forEach(conn => {
        const fromBar = document.querySelector(`.task-bar[data-task-id="${conn.from}"]`);
        const toBar = document.querySelector(`.task-bar[data-task-id="${conn.to}"]`);
        
        if (!fromBar || !toBar) return;
        
        const container = document.getElementById('gantt-container');
        if (!container) return;
        
        const tasksContainer = document.getElementById('gantt-tasks');
        if (!tasksContainer) return;
        
        const fromRect = fromBar.getBoundingClientRect();
        const toRect = toBar.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();
        const tasksRect = tasksContainer.getBoundingClientRect();
        
        let x1, y1, x2, y2;
        
        // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–µ–∫ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ SVG (–∫–æ—Ç–æ—Ä—ã–π –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ)
        // SVG –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Ç–æ–º –∂–µ —É—Ä–æ–≤–Ω–µ, —á—Ç–æ –∏ tasks, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º containerRect
        if (conn.fromPoint === 'left') {
          x1 = fromRect.left - containerRect.left;
          y1 = fromRect.top + fromRect.height / 2 - containerRect.top;
        } else if (conn.fromPoint === 'right') {
          x1 = fromRect.right - containerRect.left;
          y1 = fromRect.top + fromRect.height / 2 - containerRect.top;
        } else if (conn.fromPoint === 'top') {
          x1 = fromRect.left + fromRect.width / 2 - containerRect.left;
          y1 = fromRect.top - containerRect.top;
        } else {
          x1 = fromRect.left + fromRect.width / 2 - containerRect.left;
          y1 = fromRect.bottom - containerRect.top;
        }
        
        if (conn.toPoint === 'left') {
          x2 = toRect.left - containerRect.left;
          y2 = toRect.top + toRect.height / 2 - containerRect.top;
        } else if (conn.toPoint === 'right') {
          x2 = toRect.right - containerRect.left;
          y2 = toRect.top + toRect.height / 2 - containerRect.top;
        } else if (conn.toPoint === 'top') {
          x2 = toRect.left + toRect.width / 2 - containerRect.left;
          y2 = toRect.top - containerRect.top;
        } else {
          x2 = toRect.left + toRect.width / 2 - containerRect.left;
          y2 = toRect.bottom - containerRect.top;
        }
        
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', x1);
        line.setAttribute('y1', y1);
        line.setAttribute('x2', x2);
        line.setAttribute('y2', y2);
        line.setAttribute('stroke', 'var(--primary)');
        line.setAttribute('stroke-width', '2');
        line.setAttribute('marker-end', 'url(#arrowhead)');
        
        svg.appendChild(line);
      });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∑–∞–¥–∞—á–∏ –≤–Ω—É—Ç—Ä–∏ —ç–ø–∏–∫–∞
    function getTaskPriorityInEpic(task) {
      const taskType = (task.type || '').toLowerCase();
      const components = task.components || [];
      const hasBE = components.includes('BE');
      const hasFE = components.includes('FE');
      const hasQA = components.includes('QA');
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
      // 1. Task + BE
      // 2. Task + FE
      // 3. Task + QA
      // 4. Defect/Bug + BE
      // 5. Defect/Bug + FE
      
      if (taskType === 'task' || taskType === '–∑–∞–¥–∞—á–∞') {
        if (hasBE) return 1;
        if (hasFE) return 2;
        if (hasQA) return 3;
        return 99; // Task –±–µ–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
      } else if (taskType === 'bug' || taskType === 'defect' || taskType === '–¥–µ—Ñ–µ–∫—Ç') {
        if (hasBE) return 4;
        if (hasFE) return 5;
        return 99; // Defect –±–µ–∑ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∏–ª–∏ —Å QA (–Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è)
      }
      
      return 99; // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—è –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
    function rangesOverlap(start1, end1, range2) {
      return start1 <= range2.end && end1 >= range2.start;
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
    function areAllAssigneesFree(assignees, startDate, durationDays, assigneeCalendars) {
      if (!assignees || assignees.length === 0) {
        return true; // –ï—Å–ª–∏ –Ω–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π, —Å—á–∏—Ç–∞–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–º
      }
      
      // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è
      let daysAdded = 0;
      let endDate = startDate;
      while (daysAdded < durationDays && endDate < ganttCalendarDays.length) {
        if (!ganttCalendarDays[endDate].isWeekend) {
          daysAdded++;
        }
        if (daysAdded < durationDays) {
          endDate++;
        }
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
      for (const assignee of assignees) {
        const busyRanges = assigneeCalendars[assignee] || [];
        for (const range of busyRanges) {
          if (rangesOverlap(startDate, endDate, range)) {
            return false; // –ù–∞–π–¥–µ–Ω–æ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ
          }
        }
      }
      
      return true; // –í—Å–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ —Å–≤–æ–±–æ–¥–Ω—ã
    }
    
    // –ü–æ–∏—Å–∫ –ø–µ—Ä–≤–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –¥–∞—Ç—ã —Å—Ç–∞—Ä—Ç–∞ —Å —É—á–µ—Ç–æ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–π –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
    function findEarliestAvailableDate(task, planningStartDate, planningEndDate, assigneeCalendars) {
      const workingDays = Math.ceil(task.originalEstimate / 8);
      
      // –ï—Å–ª–∏ —É –∑–∞–¥–∞—á–∏ –Ω–µ—Ç –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π, –Ω–∞—á–∏–Ω–∞–µ–º —Å planningStartDate
      if (!task.assignees || task.assignees.length === 0) {
        let startDate = planningStartDate;
        while (startDate <= planningEndDate && ganttCalendarDays[startDate].isWeekend) {
          startDate++;
        }
        return startDate <= planningEndDate ? startDate : planningEndDate;
      }
      
      // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (–≥–ª–æ–±–∞–ª—å–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å)
      let maxEndDate = -1;
      for (const assignee of task.assignees) {
        const busyRanges = assigneeCalendars[assignee] || [];
        if (busyRanges.length > 0) {
          // –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–Ω—è—Ç—É—é –¥–∞—Ç—É –¥–ª—è —ç—Ç–æ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
          const lastRange = busyRanges[busyRanges.length - 1];
          maxEndDate = Math.max(maxEndDate, lastRange.end);
        }
      }
      
      // –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ —Å –¥–∞—Ç—ã –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–Ω—è—Ç–æ–π –¥–∞—Ç—ã –∏–ª–∏ —Å planningStartDate
      let candidateDate = Math.max(planningStartDate, maxEndDate + 1);
      
      while (candidateDate <= planningEndDate) {
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ
        if (ganttCalendarDays[candidateDate].isWeekend) {
          candidateDate++;
          continue;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—Å–µ—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (–≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
        if (areAllAssigneesFree(task.assignees, candidateDate, workingDays, assigneeCalendars)) {
          return candidateDate;
        }
        
        candidateDate++;
      }
      
      // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ —Å–≤–æ–±–æ–¥–Ω—É—é –¥–∞—Ç—É, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞
      return planningEndDate;
    }
    
    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–≥–æ–π –æ—á–µ—Ä–µ–¥–∏ —Ç–∏–∫–µ—Ç–æ–≤ —ç–ø–∏–∫–∞
    function buildOrderedTicketQueue(tickets) {
      const ORDER = [
        { type: 'task', component: 'BE' },
        { type: 'task', component: 'FE' },
        { type: 'task', component: 'QA' },
        { type: 'defect', component: 'BE' },
        { type: 'defect', component: 'FE' },
      ];
      
      const queue = [];
      
      for (const orderItem of ORDER) {
        const filtered = tickets.filter(ticket => {
          const taskType = (ticket.type || '').trim();
          const components = ticket.components || [];
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø: "–ó–∞–¥–∞—á–∞" –∏–ª–∏ "–î–µ—Ñ–µ–∫—Ç" (–Ω–∞ —Ä—É—Å—Å–∫–æ–º)
          const isTask = taskType === '–ó–∞–¥–∞—á–∞' || taskType.toLowerCase() === 'task' || taskType.toLowerCase() === '–∑–∞–¥–∞—á–∞';
          const isDefect = taskType === '–î–µ—Ñ–µ–∫—Ç' || taskType.toLowerCase() === 'bug' || taskType.toLowerCase() === 'defect' || taskType.toLowerCase() === '–¥–µ—Ñ–µ–∫—Ç';
          
          const hasComponent = components.includes(orderItem.component);
          
          if (orderItem.type === 'task') {
            return isTask && hasComponent;
          } else if (orderItem.type === 'defect') {
            return isDefect && hasComponent;
          }
          return false;
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –≤ –ø–æ—Ä—è–¥–∫–µ –ø–æ–ª—É—á–µ–Ω–∏—è (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫)
        queue.push(...filtered);
      }

      // –ï—Å–ª–∏ –Ω–µ —Å–º–æ–≥–ª–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, backend –Ω–µ –ø—Ä–∏—Å–ª–∞–ª type/components),
      // –Ω–µ –ª–æ–º–∞–µ–º –∞–≤—Ç–æ-–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Ç–∏–∫–µ—Ç–æ–≤.
      if (queue.length === 0) {
        return tickets || [];
      }

      return queue;
    }
    
    // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å—É–º–º–∞—Ä–Ω–æ–π –æ—Ü–µ–Ω–∫–∏ –≤—Å–µ—Ö –∑–∞–¥–∞—á —ç–ø–∏–∫–∞
    function calculateEpicTotalEstimate(epic) {
      let total = 0;
      epic.tasks.forEach(task => {
        total += task.originalEstimate || 0;
      });
      return total;
    }
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á
    function autoDistributeTasks() {
      try {
        if (!ganttData) {
          console.warn('Gantt: no data loaded yet');
          return;
        }
        
        // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (–∏–Ω–∞—á–µ –∫–Ω–æ–ø–∫–∞ –º–æ–∂–µ—Ç "–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—Ç—å" –∏–∑-–∑–∞ JS –æ—à–∏–±–∫–∏)
        if (!ganttState) {
          ganttState = { tasks: {}, connections: [] };
        }
        if (!ganttState.tasks) {
          ganttState.tasks = {};
        }
        
        // –î–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Å—Ä–∞–∑—É —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º —ç–ø–∏–∫–∏, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ –ø–æ–ª–æ—Å—ã
        ganttData.forEach(epic => {
          ganttExpandedEpics[String(epic.id)] = true;
        });
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º —ç–ø–∏–∫–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (DESC - –≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —Ä–∞–Ω—å—à–µ)
      // –ï—Å–ª–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π, —Ç–æ –ø–æ —Å—É–º–º–∞—Ä–Ω–æ–π –æ—Ü–µ–Ω–∫–µ (–º–µ–Ω—å—à–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∞–Ω—å—à–µ)
      const priorityOrder = { 'Highest': 0, 'High': 1, 'Medium': 2, 'Low': 3, 'Lowest': 4 };
      const sortedEpics = [...ganttData].sort((a, b) => {
        const aPriority = priorityOrder[a.priority] ?? 99;
        const bPriority = priorityOrder[b.priority] ?? 99;
        
        if (aPriority !== bPriority) {
          return aPriority - bPriority;
        }
        
        // –ï—Å–ª–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Å—É–º–º–∞—Ä–Ω–æ–π –æ—Ü–µ–Ω–∫–µ (–º–µ–Ω—å—à–∞—è –æ—Ü–µ–Ω–∫–∞ —Ä–∞–Ω—å—à–µ)
        const aTotalEstimate = calculateEpicTotalEstimate(a);
        const bTotalEstimate = calculateEpicTotalEstimate(b);
        return aTotalEstimate - bTotalEstimate;
      });
      
      // –ö–∞–ª–µ–Ω–¥–∞—Ä–∏ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π: { assigneeId: [{ start: dateIndex, end: dateIndex }] }
      const assigneeCalendars = {};
      
      const planningStartDate = 0;
      const planningEndDate = ganttCalendarDays.length - 1;
      
      // –î–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ø–∏–∫–∞ (–ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É) —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–¥–∞—á–∏ —Å—Ç—Ä–æ–≥–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
      for (const epic of sortedEpics) {
        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–≥—É—é –æ—á–µ—Ä–µ–¥—å —Ç–∏–∫–µ—Ç–æ–≤ —ç–ø–∏–∫–∞
        const orderedTickets = buildOrderedTicketQueue(epic.tasks);
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–¥–∞—á–∏ —ç—Ç–æ–≥–æ —ç–ø–∏–∫–∞
        let epicLastEndDate = -1;
        
        // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø–ª–∞–Ω–∏—Ä—É–µ–º —Ç–∏–∫–µ—Ç—ã —ç–ø–∏–∫–∞
        for (const ticket of orderedTickets) {
          const workingDays = Math.ceil(ticket.originalEstimate / 8);
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞: –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–¥–∞—á–∏ —ç–ø–∏–∫–∞
          // –ò–õ–ò –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (–±–µ—Ä–µ–º –º–∞–∫—Å–∏–º—É–º)
          let minStartDate = epicLastEndDate + 1;
          
          // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –∑–∞–¥–∞—á–∏ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å)
          if (ticket.assignees && ticket.assignees.length > 0) {
            let maxAssigneeEndDate = -1;
            for (const assignee of ticket.assignees) {
              const busyRanges = assigneeCalendars[assignee] || [];
              if (busyRanges.length > 0) {
                const lastRange = busyRanges[busyRanges.length - 1];
                maxAssigneeEndDate = Math.max(maxAssigneeEndDate, lastRange.end);
              }
            }
            // –ë–µ—Ä–µ–º –º–∞–∫—Å–∏–º—É–º: –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–¥–∞—á–∏ —ç–ø–∏–∫–∞ –ò–õ–ò –ø–æ—Å–ª–µ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π
            minStartDate = Math.max(minStartDate, maxAssigneeEndDate + 1);
          }
          
          // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –¥–∞—Ç—É —Å—Ç–∞—Ä—Ç–∞, –Ω–∞—á–∏–Ω–∞—è —Å minStartDate
          const startDate = findEarliestAvailableDate(
            ticket,
            minStartDate,
            planningEndDate,
            assigneeCalendars
          );
          
          // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è
          let daysAdded = 0;
          let endDate = startDate;
          while (daysAdded < workingDays && endDate < ganttCalendarDays.length) {
            if (!ganttCalendarDays[endDate].isWeekend) {
              daysAdded++;
            }
            if (daysAdded < workingDays) {
              endDate++;
            }
          }
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –∑–∞–¥–∞—á–∏
          ganttState.tasks[ticket.id] = {
            startDate: startDate,
          };
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–¥–∞—á–∏ —ç–ø–∏–∫–∞
          epicLastEndDate = endDate;
          
          // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∑–∞–Ω—è—Ç–æ—Å—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (–≥–ª–æ–±–∞–ª—å–Ω–æ)
          if (ticket.assignees && ticket.assignees.length > 0) {
            for (const assignee of ticket.assignees) {
              if (!assigneeCalendars[assignee]) {
                assigneeCalendars[assignee] = [];
              }
              assigneeCalendars[assignee].push({
                start: startDate,
                end: endDate,
              });
              // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –ø–æ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
              assigneeCalendars[assignee].sort((a, b) => a.start - b.start);
            }
          }
        }
      }
      
      ganttAutoMode = true;
      document.getElementById('gantt-remove-auto').style.display = 'inline-block';
      document.getElementById('gantt-save').style.display = 'inline-block';
      
      renderGantt();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–≤—è–∑–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
      setTimeout(() => {
        renderGanttConnections();
      }, 100);
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ autoDistributeTasks:', e);
        const error = document.getElementById('gantt-error');
        if (error) {
          error.style.display = 'block';
          error.innerHTML = `–û—à–∏–±–∫–∞ –∞–≤—Ç–æ-—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è: ${e && e.message ? e.message : e}`;
        }
      }
    }
    
    // –£–±—Ä–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
    function removeAutoDistribution() {
      if (!ganttState.tasks) return;
      
      // –£–¥–∞–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –∑–∞–¥–∞—á
      ganttState.tasks = {};
      ganttAutoMode = false;
      
      document.getElementById('gantt-remove-auto').style.display = 'none';
      document.getElementById('gantt-save').style.display = 'inline-block';
      
      renderGantt();
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    async function saveGanttState() {
      try {
        const response = await fetch(`/api/teams/${teamId}/gantt/state${isCustom ? "?custom=1" : ""}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            state: ganttState,
            autoMode: ganttAutoMode,
            expandedEpics: ganttExpandedEpics,
          }),
        });
        
        const result = await response.json();
        if (result.success) {
          document.getElementById('gantt-save').style.display = 'none';
        } else {
          console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', result.error);
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', e);
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    async function loadGanttState() {
      try {
        const response = await fetch(`/api/teams/${teamId}/gantt/state${isCustom ? "?custom=1" : ""}`);
        const result = await response.json();
        
        if (result.success && result.data) {
          ganttState = result.data.state || { tasks: {}, connections: [] };
          ganttAutoMode = result.data.autoMode || false;
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ—Å—Ç–∏ —ç–ø–∏–∫–æ–≤
          if (result.data.expandedEpics) {
            ganttExpandedEpics = result.data.expandedEpics;
          }
        } else {
          ganttState = { tasks: {}, connections: [] };
          ganttAutoMode = false;
          ganttExpandedEpics = {};
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:', e);
        ganttState = { tasks: {}, connections: [] };
        ganttAutoMode = false;
        ganttExpandedEpics = {};
      }
    }
    // ==================== TODO ====================
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è Todo
    let todoCurrentList = 'my-day';
    let todoTasks = [];
    let todoLists = [];
    let todoSelectedTask = null;
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ Todo –¥–∞–Ω–Ω—ã—Ö
    async function loadTodo() {
      try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏
        const listsResponse = await fetch(`/api/todo/lists`);
        if (listsResponse.ok) {
          const listsData = await listsResponse.json();
          if (listsData.success) {
            todoLists = listsData.data || [];
            renderTodoLists();
          }
        } else {
          // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          console.warn('Todo lists not available:', listsResponse.status);
        }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        await loadTodoTasks();
      } catch (e) {
        console.error('Todo load error:', e);
      }
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–¥–∞—á –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    async function loadTodoTasks() {
      try {
        const response = await fetch(`/api/todo/tasks?list=${todoCurrentList}`);
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            todoTasks = data.data || [];
            renderTodoTasks();
          }
        } else {
          // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –ø—Ä–æ—Å—Ç–æ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          console.warn('Todo tasks not available:', response.status);
          todoTasks = [];
          renderTodoTasks();
        }
      } catch (e) {
        console.error('Todo tasks load error:', e);
        todoTasks = [];
        renderTodoTasks();
      }
    }
    
    // –í—ã–±–æ—Ä —Å–ø–∏—Å–∫–∞
    function selectTodoList(listType) {
      todoCurrentList = listType;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —Å–ø–∏—Å–æ–∫
      document.querySelectorAll('.todo-list-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-list-type="${listType}"]`)?.classList.add('active');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
      const titles = {
        'my-day': '–ú–æ–π –¥–µ–Ω—å',
        'important': '–í–∞–∂–Ω–æ',
        'planned': '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ',
        'all': '–í—Å–µ',
        'completed': '–í—ã–ø–æ–ª–Ω–µ–Ω–æ'
      };
      document.getElementById('todo-list-title').textContent = titles[listType] || '–°–ø–∏—Å–æ–∫';
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–¥–∞—á–∏
      loadTodoTasks();
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏
      document.getElementById('todo-details').style.display = 'none';
      todoSelectedTask = null;
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–æ–≤
    function renderTodoLists() {
      const container = document.getElementById('todo-custom-lists');
      container.innerHTML = '';
      
      todoLists.forEach(list => {
        const item = document.createElement('div');
        item.className = 'todo-list-item';
        item.dataset.listId = list.id;
        item.onclick = () => selectTodoList(`custom-${list.id}`);
        item.innerHTML = `
          <span class="todo-list-icon">üìù</span>
          <span class="todo-list-name">${escapeHtml(list.name)}</span>
          <span class="todo-list-actions" onclick="event.stopPropagation(); showEditListDialog(${list.id})" style="margin-left: auto; opacity: 0.5; cursor: pointer;">‚úèÔ∏è</span>
        `;
        container.appendChild(item);
      });
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∑–∞–¥–∞—á
    function renderTodoTasks() {
      const container = document.getElementById('todo-tasks-list');
      container.innerHTML = '';
      
      if (todoTasks.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 40px;">–ù–µ—Ç –∑–∞–¥–∞—á</div>';
        return;
      }
      
      todoTasks.forEach(task => {
        // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∑–∞–¥–∞—á–∏ –∏ –µ—ë –ø–æ–¥–∑–∞–¥–∞—á
        const taskWrapper = document.createElement('div');
        taskWrapper.className = 'todo-task-wrapper';
        
        const taskDiv = document.createElement('div');
        taskDiv.className = 'todo-task-item';
        taskDiv.dataset.taskId = task.id;
        if (task.completed) {
          taskDiv.classList.add('completed');
        }
        
        const priorityIcon = task.priority === 'important' ? '‚≠ê' : '';
        const dueDate = task.due_date ? new Date(task.due_date).toLocaleDateString('ru-RU') : '';
        const reminder = task.reminder ? new Date(task.reminder).toLocaleString('ru-RU') : '';
        
        const isFavorite = task.priority === 'important';
        taskDiv.innerHTML = `
          <input type="checkbox" class="todo-checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTodoTask(${task.id}, this.checked)">
          <span class="todo-task-name" onclick="openTodoTaskDetails(${task.id})">${escapeHtml(task.name)}</span>
          <span class="todo-task-indicators">
            ${priorityIcon ? `<span title="–í–∞–∂–Ω–æ">${priorityIcon}</span>` : ''}
            ${dueDate ? `<span title="–î–∞—Ç–∞: ${dueDate}">üìÖ</span>` : ''}
            ${reminder ? `<span title="–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: ${reminder}">üîî</span>` : ''}
            ${task.repeat ? `<span title="–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ">üîÑ</span>` : ''}
            <span class="todo-favorite-icon" onclick="event.stopPropagation(); toggleTodoFavorite(${task.id}, ${!isFavorite})" title="${isFavorite ? '–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}">${isFavorite ? '‚≠ê' : '‚òÜ'}</span>
          </span>
        `;
        
        taskWrapper.appendChild(taskDiv);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–æ–¥–∑–∞–¥–∞—á - —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç—Ç–æ –º–∞—Å—Å–∏–≤
        const subtasks = Array.isArray(task.subtasks) ? task.subtasks : [];
        
        if (subtasks && subtasks.length > 0) {
          const subtasksContainer = document.createElement('div');
          subtasksContainer.className = 'todo-subtasks-container';
          
          subtasks.forEach(subtask => {
            const subtaskDiv = document.createElement('div');
            subtaskDiv.className = 'todo-subtask-item';
            subtaskDiv.dataset.subtaskId = subtask.id;
            if (subtask.completed) {
              subtaskDiv.classList.add('completed');
            }
            
            subtaskDiv.innerHTML = `
              <input type="checkbox" class="todo-checkbox" ${subtask.completed ? 'checked' : ''} onchange="toggleTodoSubtask(${subtask.id}, this.checked)">
              <span class="todo-subtask-name">${escapeHtml(subtask.name)}</span>
            `;
            
            subtasksContainer.appendChild(subtaskDiv);
          });
          
          taskWrapper.appendChild(subtasksContainer);
        }
        
        container.appendChild(taskWrapper);
      });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏
    async function handleTodoTaskInput(event) {
      if (event.key === 'Enter' && !event.ctrlKey) {
        event.preventDefault();
        const input = event.target;
        const name = input.value.trim();
        if (name) {
          await createTodoTask(name);
          input.value = '';
          input.style.height = 'auto';
        }
      } else if (event.key === 'Enter' && event.ctrlKey) {
        // Ctrl+Enter - –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º
        return;
      }
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
    async function createTodoTask(name) {
      try {
        let listId = null;
        let listType = null;
        
        if (todoCurrentList.startsWith('custom-')) {
          listId = parseInt(todoCurrentList.replace('custom-', ''));
        } else {
          // –î–ª—è —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º list_type
          listType = todoCurrentList;
          // –ï—Å–ª–∏ —ç—Ç–æ "important" –∏–ª–∏ "planned", —Ç–∞–∫–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
          if (todoCurrentList === 'important') {
            // –î–ª—è —Å–ø–∏—Å–∫–∞ "–í–∞–∂–Ω–æ" —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º priority
            // –ù–æ list_type –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –∑–∞–¥–∞—á–∞ –ø–æ–ø–∞–ª–∞ –≤ —Ñ–∏–ª—å—Ç—Ä
          } else if (todoCurrentList === 'planned') {
            // –î–ª—è —Å–ø–∏—Å–∫–∞ "–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ" –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å due_date
            // –ù–æ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏
          }
        }
        
        const response = await fetch('/api/todo/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            list_id: listId,
            list_type: listType,
            priority: todoCurrentList === 'important' ? 'important' : 'normal',
          }),
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            await loadTodoTasks();
            return data.data;
          }
        }
      } catch (e) {
        console.error('Create task error:', e);
      }
      return null;
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    async function toggleTodoFavorite(taskId, isFavorite) {
      try {
        const response = await fetch(`/api/todo/tasks/${taskId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ priority: isFavorite ? 'important' : 'normal' }),
        });
        
        if (response.ok) {
          await loadTodoTasks();
        }
      } catch (e) {
        console.error('Toggle favorite error:', e);
      }
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏
    async function toggleTodoTask(taskId, completed) {
      try {
        const response = await fetch(`/api/todo/tasks/${taskId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completed }),
        });
        
        if (response.ok) {
          await loadTodoTasks();
        }
      } catch (e) {
        console.error('Toggle task error:', e);
      }
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏
    async function openTodoTaskDetails(taskId) {
      try {
        const response = await fetch(`/api/todo/tasks/${taskId}`);
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            todoSelectedTask = data.data;
            // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ subtasks - –º–∞—Å—Å–∏–≤
            if (!todoSelectedTask.subtasks) {
              todoSelectedTask.subtasks = [];
            }
            renderTodoTaskDetails();
            document.getElementById('todo-details').style.display = 'block';
          }
        } else {
          const errorData = await response.json();
          console.error('Open task details error:', errorData.error || 'Unknown error');
        }
      } catch (e) {
        console.error('Open task details error:', e);
      }
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏
    function renderTodoTaskDetails() {
      if (!todoSelectedTask) return;
      
      document.getElementById('todo-details-name').value = todoSelectedTask.name || '';
      document.getElementById('todo-details-completed').checked = todoSelectedTask.completed || false;
      document.getElementById('todo-details-priority').value = todoSelectedTask.priority || 'normal';
      document.getElementById('todo-details-due-date').value = todoSelectedTask.due_date ? todoSelectedTask.due_date.split('T')[0] : '';
      document.getElementById('todo-details-reminder').value = todoSelectedTask.reminder ? new Date(todoSelectedTask.reminder).toISOString().slice(0, 16) : '';
      document.getElementById('todo-details-repeat').value = todoSelectedTask.repeat || '';
      document.getElementById('todo-details-notes').value = todoSelectedTask.notes || '';
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è
      const createdEl = document.getElementById('todo-details-created');
      if (todoSelectedTask.created_at) {
        const createdDate = new Date(todoSelectedTask.created_at);
        createdEl.textContent = createdDate.toLocaleString('ru-RU', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      } else {
        createdEl.textContent = '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
      }
      
      // –†–µ–Ω–¥–µ—Ä–∏–º –ø–æ–¥–∑–∞–¥–∞—á–∏
      renderTodoSubtasks();
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø–æ–¥–∑–∞–¥–∞—á
    function renderTodoSubtasks() {
      const container = document.getElementById('todo-details-subtasks');
      container.innerHTML = '';
      
      if (!todoSelectedTask.subtasks || todoSelectedTask.subtasks.length === 0) {
        return;
      }
      
      todoSelectedTask.subtasks.forEach(subtask => {
        const div = document.createElement('div');
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.gap = '8px';
        div.style.marginBottom = '8px';
        div.innerHTML = `
          <input type="checkbox" ${subtask.completed ? 'checked' : ''} onchange="toggleTodoSubtask(${subtask.id}, this.checked)">
          <input type="text" value="${escapeHtml(subtask.name)}" style="flex: 1; padding: 4px 8px; border: 1px solid var(--border); border-radius: 4px;" onchange="updateTodoSubtask(${subtask.id}, this.value)">
          <button onclick="deleteTodoSubtask(${subtask.id})" style="padding: 4px 8px; background: #ff5b5b; color: white; border: none; border-radius: 4px; cursor: pointer;">√ó</button>
        `;
        container.appendChild(div);
      });
    }
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏
    async function saveTodoTaskDetails() {
      if (!todoSelectedTask) return;
      
      try {
        const response = await fetch(`/api/todo/tasks/${todoSelectedTask.id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: document.getElementById('todo-details-name').value,
            completed: document.getElementById('todo-details-completed').checked,
            priority: document.getElementById('todo-details-priority').value,
            due_date: document.getElementById('todo-details-due-date').value || null,
            reminder: document.getElementById('todo-details-reminder').value || null,
            repeat: document.getElementById('todo-details-repeat').value || null,
            notes: document.getElementById('todo-details-notes').value,
          }),
        });
        
        if (response.ok) {
          await loadTodoTasks();
          await openTodoTaskDetails(todoSelectedTask.id);
        }
      } catch (e) {
        console.error('Save task details error:', e);
      }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
    async function deleteTodoTask() {
      if (!todoSelectedTask || !confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
      
      try {
        const response = await fetch(`/api/todo/tasks/${todoSelectedTask.id}`, {
          method: 'DELETE',
        });
        
        if (response.ok) {
          document.getElementById('todo-details').style.display = 'none';
          todoSelectedTask = null;
          await loadTodoTasks();
        }
      } catch (e) {
        console.error('Delete task error:', e);
      }
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∏
    async function addTodoSubtask() {
      if (!todoSelectedTask) return;
      
      const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∏:');
      if (!name) return;
      
      try {
        const response = await fetch(`/api/todo/tasks/${todoSelectedTask.id}/subtasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name }),
        });
        
        if (response.ok) {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á, —á—Ç–æ–±—ã –ø–æ–¥–∑–∞–¥–∞—á–∞ –æ—Ç–æ–±—Ä–∞–∑–∏–ª–∞—Å—å
          await loadTodoTasks();
          // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏
          await openTodoTaskDetails(todoSelectedTask.id);
        }
      } catch (e) {
        console.error('Add subtask error:', e);
      }
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∏
    async function toggleTodoSubtask(subtaskId, completed) {
      try {
        const response = await fetch(`/api/todo/subtasks/${subtaskId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completed }),
        });
        
        if (response.ok) {
          // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á
          await loadTodoTasks();
          // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å, –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë —Ç–æ–∂–µ
          if (todoSelectedTask) {
            await openTodoTaskDetails(todoSelectedTask.id);
          }
        }
      } catch (e) {
        console.error('Toggle subtask error:', e);
      }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∏
    async function updateTodoSubtask(subtaskId, name) {
      try {
        const response = await fetch(`/api/todo/subtasks/${subtaskId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name }),
        });
        
        if (response.ok) {
          await openTodoTaskDetails(todoSelectedTask.id);
        }
      } catch (e) {
        console.error('Update subtask error:', e);
      }
    }
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–∑–∞–¥–∞—á–∏
    async function deleteTodoSubtask(subtaskId) {
      try {
        const response = await fetch(`/api/todo/subtasks/${subtaskId}`, {
          method: 'DELETE',
        });
        
        if (response.ok) {
          await openTodoTaskDetails(todoSelectedTask.id);
        }
      } catch (e) {
        console.error('Delete subtask error:', e);
      }
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–¥–∞—á
    function filterTodoTasks() {
      // TODO: —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
      renderTodoTasks();
    }
    
    // –ü–æ–∫–∞–∑ –¥–∏–∞–ª–æ–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
    function showAddListDialog() {
      const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞:');
      if (name) {
        createTodoList(name);
      }
    }
    
    // –ü–æ–∫–∞–∑ –¥–∏–∞–ª–æ–≥–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞
    function showEditListDialog(listId) {
      const list = todoLists.find(l => l.id === listId);
      if (!list) return;
      
      const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞:', list.name);
      if (name && name !== list.name) {
        updateTodoList(listId, name);
      }
    }
    
    // –°–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞
    async function createTodoList(name) {
      try {
        const response = await fetch('/api/todo/lists', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name }),
        });
        
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            await loadTodo();
          }
        }
      } catch (e) {
        console.error('Create list error:', e);
      }
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞
    async function updateTodoList(listId, name) {
      try {
        const response = await fetch(`/api/todo/lists/${listId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name }),
        });
        
        if (response.ok) {
          await loadTodo();
        }
      } catch (e) {
        console.error('Update list error:', e);
      }
    }
    
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è Todo
    const todoStyles = document.createElement('style');
    todoStyles.textContent = `
      .todo-list-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .todo-list-item:hover {
        background: var(--hover);
      }
      .todo-list-item.active {
        background: var(--primary);
        color: white;
      }
      .todo-list-icon {
        font-size: 18px;
      }
      .todo-list-name {
        flex: 1;
        font-size: 14px;
      }
      .todo-task-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-bottom: 1px solid var(--border);
        cursor: pointer;
        transition: background 0.2s;
      }
      .todo-task-item:hover {
        background: var(--hover);
      }
      .todo-task-item.completed .todo-task-name {
        text-decoration: line-through;
        opacity: 0.6;
      }
      .todo-task-name {
        flex: 1;
        font-size: 14px;
      }
      .todo-task-indicators {
        display: flex;
        gap: 8px;
        font-size: 14px;
        align-items: center;
      }
      .todo-favorite-icon {
        cursor: pointer;
        font-size: 18px;
        opacity: 0.7;
        transition: opacity 0.2s;
      }
      .todo-favorite-icon:hover {
        opacity: 1;
      }
      .todo-task-wrapper {
        border-bottom: 1px solid var(--border);
      }
      .todo-subtasks-container {
        padding-left: 40px;
        background: rgba(0, 0, 0, 0.1);
      }
      .todo-subtask-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 12px;
        border-bottom: 1px solid var(--border);
        font-size: 13px;
        opacity: 0.9;
      }
      .todo-subtask-item:last-child {
        border-bottom: none;
      }
      .todo-subtask-item:hover {
        background: rgba(255, 255, 255, 0.05);
      }
      .todo-subtask-item.completed .todo-subtask-name {
        text-decoration: line-through;
        opacity: 0.6;
      }
      .todo-subtask-name {
        flex: 1;
        font-size: 13px;
      }
      /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ */
      .todo-checkbox {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid var(--border);
        background: var(--card);
        cursor: pointer;
        appearance: none;
        -webkit-appearance: none;
        position: relative;
        flex-shrink: 0;
      }
      .todo-checkbox:checked {
        background: var(--primary);
        border-color: var(--primary);
      }
      .todo-checkbox:checked::after {
        content: '‚úì';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: black;
        font-size: 14px;
        font-weight: bold;
      }
      .todo-checkbox:hover {
        border-color: var(--primary);
      }
      /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–ø—É—Ç–æ–≤ –∏ —Å–µ–ª–µ–∫—Ç–æ–≤ */
      #todo-search::placeholder,
      #todo-new-task-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }
      #todo-filter-priority {
        color: black;
      }
      #todo-filter-priority option {
        background: white;
        color: black;
      }
      /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–∞–≤–æ–π –ø–∞–Ω–µ–ª–∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏ */
      #todo-details {
        color: white;
      }
      #todo-details label {
        color: rgba(255, 255, 255, 0.7);
      }
      #todo-details input[type="text"],
      #todo-details input[type="date"],
      #todo-details input[type="datetime-local"],
      #todo-details select,
      #todo-details textarea {
        color: white;
      }
      #todo-details input[type="text"]::placeholder,
      #todo-details textarea::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }
      #todo-details select option {
        background: var(--card);
        color: white;
      }
      #todo-details span {
        color: white;
      }
    `;
    document.head.appendChild(todoStyles);
    
  </script>

  <!-- –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É" -->
  <button id="fab-create-issue" class="fab-button" onclick="openCreateIssueModal()" title="–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –≤ Jira" style="position: fixed; top: 24px; right: 24px; padding: 12px 20px; border-radius: 8px; background: var(--primary); color: white; border: none; cursor: pointer; box-shadow: 0 4px 12px rgba(91, 140, 255, 0.4); display: flex; align-items: center; justify-content: center; gap: 8px; z-index: 1000; transition: all 0.3s ease; font-weight: 600; font-size: 14px; white-space: nowrap;">
    <span style="font-size: 18px; line-height: 1;">+</span>
    <span>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</span>
  </button>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
  <div id="create-issue-modal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; z-index: 2000; padding: 20px; backdrop-filter: blur(4px);">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 24px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); color: var(--text);">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É –≤ Jira</h2>
        <button onclick="closeCreateIssueModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--muted);">&times;</button>
      </div>

      <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ -->
      <div style="margin-bottom: 20px; display: flex; gap: 10px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="radio" name="create-mode" value="text" checked onchange="switchCreateMode('text')" style="margin-right: 8px;">
          <span>–¢–µ–∫—Å—Ç</span>
        </label>
        <label style="display: flex; align-items: center; cursor: pointer;">
          <input type="radio" name="create-mode" value="voice" onchange="switchCreateMode('voice')" style="margin-right: 8px;">
          <span>–ì–æ–ª–æ—Å</span>
        </label>
      </div>

      <!-- –ì–æ–ª–æ—Å–æ–≤–æ–π —Ä–µ–∂–∏–º -->
      <div id="voice-mode" style="display: none; margin-bottom: 20px;">
        <div style="text-align: center; padding: 20px; border: 2px dashed var(--border); border-radius: 8px; margin-bottom: 15px;">
          <button id="voice-record-btn" onclick="startVoiceRecognition()" style="padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin-bottom: 10px;">
            üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å
          </button>
          <div id="voice-status" style="color: var(--muted); font-size: 14px; margin-top: 10px;"></div>
          <div id="voice-recording-indicator" style="display: none; margin-top: 10px;">
            <div class="voice-recording" style="display: inline-block; width: 12px; height: 12px; background: #ff5b5b; border-radius: 50%; animation: pulse 1.5s infinite;"></div>
            <span style="margin-left: 8px; color: #ff5b5b;">–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...</span>
          </div>
        </div>
        <div id="voice-preview" style="display: none; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; margin-bottom: 15px;">
          <div style="font-size: 12px; color: var(--muted); margin-bottom: 8px;">–†–∞—Å–ø–æ–∑–Ω–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</div>
          <div id="voice-preview-text" style="color: white; white-space: pre-wrap;"></div>
        </div>
      </div>

      <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
      <form id="create-issue-form" onsubmit="event.preventDefault(); createJiraIssue();">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600;">–ü—Ä–æ–µ–∫—Ç *</label>
          <select id="issue-project" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white;">
            <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
          </select>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600;">–¢–∏–ø –∑–∞–¥–∞—á–∏ *</label>
          <select id="issue-type" required style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white;">
            <option value="Task">–ó–∞–¥–∞—á–∞</option>
            <option value="Bug">–ë–∞–≥</option>
          </select>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600;">–ó–∞–≥–æ–ª–æ–≤–æ–∫ *</label>
          <input type="text" id="issue-summary" required placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–¥–∞—á–∏" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white; box-sizing: border-box;">
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600;">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="issue-description" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white; resize: vertical; box-sizing: border-box; font-family: inherit;"></textarea>
        </div>

        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600;">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
          <select id="issue-priority" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white;">
            <option value="">–ù–µ —É–∫–∞–∑–∞–Ω</option>
            <option value="Highest">Highest</option>
            <option value="High">High</option>
            <option value="Medium" selected>Medium</option>
            <option value="Low">Low</option>
            <option value="Lowest">Lowest</option>
          </select>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 6px; font-weight: 600;">–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∑–∞–¥–∞—á–∞</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="issue-parent" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, TNL-123) –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ" style="flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 6px; background: var(--card); color: white; box-sizing: border-box;">
            <button type="button" onclick="searchParentIssue()" style="padding: 10px 16px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer;">–ù–∞–π—Ç–∏</button>
          </div>
          <div id="parent-search-results" style="margin-top: 8px; display: none; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; background: var(--card);"></div>
        </div>

        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" onclick="closeCreateIssueModal()" style="padding: 10px 20px; background: transparent; color: var(--muted); border: 1px solid var(--border); border-radius: 6px; cursor: pointer;">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" id="create-issue-submit" style="padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
        </div>

        <div id="create-issue-loading" style="display: none; text-align: center; margin-top: 16px; color: var(--muted);">
          –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏...
        </div>
        <div id="create-issue-error" style="display: none; margin-top: 16px; padding: 12px; background: rgba(255, 91, 91, 0.1); border: 1px solid #ff5b5b; border-radius: 6px; color: #ff5b5b;"></div>
        <div id="create-issue-success" style="display: none; margin-top: 16px; padding: 12px; background: rgba(76, 175, 80, 0.1); border: 1px solid #4caf50; border-radius: 6px; color: #4caf50;"></div>
      </form>
    </div>
  </div>

  <script>
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏ –≤ Jira
    
    function openCreateIssueModal() {
      const modal = document.getElementById('create-issue-modal');
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      modal.style.display = 'flex';
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.right = '0';
      modal.style.bottom = '0';
      modal.style.background = 'rgba(0, 0, 0, 0.7)';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = '2000';
      modal.style.padding = '20px';
      modal.style.backdropFilter = 'blur(4px)';
      
      loadJiraProjects();
      // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
      document.getElementById('create-issue-form').reset();
      document.getElementById('create-issue-error').style.display = 'none';
      document.getElementById('create-issue-success').style.display = 'none';
      document.getElementById('parent-search-results').style.display = 'none';
      document.getElementById('voice-preview').style.display = 'none';
      switchCreateMode('text');
    }

    function closeCreateIssueModal() {
      const modal = document.getElementById('create-issue-modal');
      modal.style.display = 'none';
      stopVoiceRecognition();
    }

    function switchCreateMode(mode) {
      const voiceMode = document.getElementById('voice-mode');
      if (mode === 'voice') {
        voiceMode.style.display = 'block';
      } else {
        voiceMode.style.display = 'none';
        stopVoiceRecognition();
      }
    }

    async function loadJiraProjects() {
      const select = document.getElementById('issue-project');
      select.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>';
      
      try {
        const response = await fetch('/api/jira/projects');
        const result = await response.json();
        
        if (result.success && result.data) {
          select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</option>';
          result.data.forEach(project => {
            const option = document.createElement('option');
            option.value = project.key;
            option.textContent = `${project.key} - ${project.name}`;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤</option>';
        }
      } catch (e) {
        console.error('Load projects error:', e);
        select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤</option>';
      }
    }

    async function searchParentIssue() {
      const query = document.getElementById('issue-parent').value.trim();
      if (!query) {
        return;
      }

      const resultsDiv = document.getElementById('parent-search-results');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--muted);">–ü–æ–∏—Å–∫...</div>';

      try {
        const response = await fetch(`/api/jira/issues/search?query=${encodeURIComponent(query)}`);
        const result = await response.json();

        if (result.success && result.data && result.data.length > 0) {
          resultsDiv.innerHTML = '';
          result.data.forEach(issue => {
            const div = document.createElement('div');
            div.style.cssText = 'padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; hover:background: rgba(255,255,255,0.05);';
            div.innerHTML = `<strong style="color: var(--primary);">${escapeHtml(issue.key)}</strong> - ${escapeHtml(issue.summary)}`;
            div.onclick = () => {
              document.getElementById('issue-parent').value = issue.key;
              resultsDiv.style.display = 'none';
            };
            div.onmouseover = () => div.style.background = 'rgba(255,255,255,0.05)';
            div.onmouseout = () => div.style.background = 'transparent';
            resultsDiv.appendChild(div);
          });
        } else {
          resultsDiv.innerHTML = '<div style="padding: 12px; text-align: center; color: var(--muted);">–ó–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        }
      } catch (e) {
        console.error('Search parent error:', e);
        resultsDiv.innerHTML = '<div style="padding: 12px; text-align: center; color: #ff5b5b;">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>';
      }
    }

    async function createJiraIssue() {
      const submitBtn = document.getElementById('create-issue-submit');
      const loadingDiv = document.getElementById('create-issue-loading');
      const errorDiv = document.getElementById('create-issue-error');
      const successDiv = document.getElementById('create-issue-success');

      // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
      loadingDiv.style.display = 'block';
      submitBtn.disabled = true;

      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
      const project = document.getElementById('issue-project').value.trim();
      const issuetype = document.getElementById('issue-type').value;
      const summary = document.getElementById('issue-summary').value.trim();
      const description = document.getElementById('issue-description').value.trim();
      const priority = document.getElementById('issue-priority').value;
      const parent = document.getElementById('issue-parent').value.trim();

      if (!project || !summary || !issuetype) {
        errorDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –ü—Ä–æ–µ–∫—Ç, –¢–∏–ø –∑–∞–¥–∞—á–∏, –ó–∞–≥–æ–ª–æ–≤–æ–∫';
        errorDiv.style.display = 'block';
        loadingDiv.style.display = 'none';
        submitBtn.disabled = false;
        return;
      }

      const body = {
        project: project,
        issuetype: issuetype,
        summary: summary,
      };

      if (description) body.description = description;
      if (priority) body.priority = priority;
      if (parent) body.parent = parent;

      try {
        const response = await fetch('/api/jira/issues/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(body),
        });

        const result = await response.json();

        if (result.success) {
          successDiv.innerHTML = `–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞: <a href="${result.data.url}" target="_blank" style="color: #4caf50; text-decoration: underline;">${result.data.key}</a>`;
          successDiv.style.display = 'block';
          
          // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
          setTimeout(() => {
            closeCreateIssueModal();
          }, 2000);
        } else {
          errorDiv.textContent = result.error || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏';
          errorDiv.style.display = 'block';
        }
      } catch (e) {
        console.error('Create issue error:', e);
        errorDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏: ' + e.message;
        errorDiv.style.display = 'block';
      } finally {
        loadingDiv.style.display = 'none';
        submitBtn.disabled = false;
      }
    }

    // –ì–æ–ª–æ—Å–æ–≤–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
    let recognition = null;
    let isRecording = false;

    function startVoiceRecognition() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome, Edge –∏–ª–∏ Safari.');
        switchCreateMode('text');
        return;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ru-RU';
      recognition.continuous = false;
      recognition.interimResults = false;

      const recordBtn = document.getElementById('voice-record-btn');
      const statusDiv = document.getElementById('voice-status');
      const indicatorDiv = document.getElementById('voice-recording-indicator');
      const previewDiv = document.getElementById('voice-preview');
      const previewText = document.getElementById('voice-preview-text');

      recognition.onstart = () => {
        isRecording = true;
        recordBtn.textContent = '‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å';
        recordBtn.onclick = stopVoiceRecognition;
        statusDiv.textContent = '–ì–æ–≤–æ—Ä–∏—Ç–µ...';
        indicatorDiv.style.display = 'block';
        previewDiv.style.display = 'none';
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        previewText.textContent = transcript;
        previewDiv.style.display = 'block';
        
        const parsed = parseVoiceInput(transcript);
        fillFormFromVoice(parsed);
        
        statusDiv.textContent = '–†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º—É –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É".';
      };

      recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        if (event.error === 'no-speech') {
          statusDiv.textContent = '–†–µ—á—å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.';
        } else if (event.error === 'not-allowed') {
          statusDiv.textContent = '–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
        } else {
          statusDiv.textContent = '–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ' + event.error;
        }
        stopVoiceRecognition();
      };

      recognition.onend = () => {
        isRecording = false;
        recordBtn.textContent = 'üé§ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å';
        recordBtn.onclick = startVoiceRecognition;
        indicatorDiv.style.display = 'none';
      };

      try {
        recognition.start();
      } catch (e) {
        console.error('Start recognition error:', e);
        statusDiv.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.';
      }
    }

    function stopVoiceRecognition() {
      if (recognition && isRecording) {
        recognition.stop();
      }
    }

    function parseVoiceInput(text) {
      const result = {};
      const lowerText = text.toLowerCase();

      // –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≥–æ–ª–æ–≤–∫–∞
      const summaryMatch = text.match(/(?:–∑–∞–≥–æ–ª–æ–≤–æ–∫|–Ω–∞–∑–≤–∞–Ω–∏–µ|title)[\s:]+(.+?)(?=\s+(?:–æ–ø–∏—Å–∞–Ω–∏–µ|–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç|—Ç–∏–ø|—Ä–æ–¥–∏—Ç–µ–ª—å|$))/i);
      if (summaryMatch) {
        result.summary = summaryMatch[1].trim();
      } else {
        // –ï—Å–ª–∏ –Ω–µ—Ç –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞, –±–µ—Ä–µ–º –Ω–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞
        const firstKeyword = text.match(/\s+(–æ–ø–∏—Å–∞–Ω–∏–µ|–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç|—Ç–∏–ø|—Ä–æ–¥–∏—Ç–µ–ª—å)/i);
        if (firstKeyword) {
          result.summary = text.substring(0, firstKeyword.index).trim();
        } else {
          result.summary = text.trim();
        }
      }

      // –ü–∞—Ä—Å–∏–Ω–≥ –æ–ø–∏—Å–∞–Ω–∏—è
      const descMatch = text.match(/(?:–æ–ø–∏—Å–∞–Ω–∏–µ|description)[\s:]+(.+?)(?=\s+(?:–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç|—Ç–∏–ø|—Ä–æ–¥–∏—Ç–µ–ª—å|–∑–∞–≥–æ–ª–æ–≤–æ–∫|$))/i);
      if (descMatch) {
        result.description = descMatch[1].trim();
      }

      // –ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞
      const priorityMatch = text.match(/(?:–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç|priority)[\s:]+(–Ω–∞–∏–≤—ã—Å—à–∏–π|–≤—ã—Å–æ–∫–∏–π|—Å—Ä–µ–¥–Ω–∏–π|–Ω–∏–∑–∫–∏–π|–Ω–∞–∏–Ω–∏–∑—à–∏–π|highest|high|medium|low|lowest)/i);
      if (priorityMatch) {
        const priorityText = priorityMatch[1].toLowerCase();
        const priorityMap = {
          '–Ω–∞–∏–≤—ã—Å—à–∏–π': 'Highest',
          '–≤—ã—Å–æ–∫–∏–π': 'High',
          '—Å—Ä–µ–¥–Ω–∏–π': 'Medium',
          '–Ω–∏–∑–∫–∏–π': 'Low',
          '–Ω–∞–∏–Ω–∏–∑—à–∏–π': 'Lowest',
          'highest': 'Highest',
          'high': 'High',
          'medium': 'Medium',
          'low': 'Low',
          'lowest': 'Lowest',
        };
        result.priority = priorityMap[priorityText] || 'Medium';
      }

      // –ü–∞—Ä—Å–∏–Ω–≥ —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏
      const typeMatch = text.match(/(?:—Ç–∏–ø|type)[\s:]+(–∑–∞–¥–∞—á–∞|task|–±–∞–≥|bug)/i);
      if (typeMatch) {
        const typeText = typeMatch[1].toLowerCase();
        if (typeText === '–±–∞–≥' || typeText === 'bug') {
          result.issuetype = 'Bug';
        } else {
          result.issuetype = 'Task';
        }
      }

      // –ü–∞—Ä—Å–∏–Ω–≥ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –∑–∞–¥–∞—á–∏
      const parentMatch = text.match(/(?:—Ä–æ–¥–∏—Ç–µ–ª—å|parent|—ç–ø–∏–∫)[\s:]+([A-Z]+-\d+)/i);
      if (parentMatch) {
        result.parent = parentMatch[1];
      }

      return result;
    }

    function fillFormFromVoice(data) {
      if (data.summary) {
        document.getElementById('issue-summary').value = data.summary;
      }
      if (data.description) {
        document.getElementById('issue-description').value = data.description;
      }
      if (data.priority) {
        document.getElementById('issue-priority').value = data.priority;
      }
      if (data.issuetype) {
        document.getElementById('issue-type').value = data.issuetype;
      }
      if (data.parent) {
        document.getElementById('issue-parent').value = data.parent;
      }
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ overlay
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('create-issue-modal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeCreateIssueModal();
          }
        });
      }
    });
  </script>
</body>
</html>


